define(["./helpers","./request","./route"],function(e,g,h){var k=e.each,f=e.addEvent,l=e.isArray;e=function(){this._routes=null;this._exits=[];this._dispatchingStarted=this._silent=!1};e.prototype={setup:function(a){a=a||{};for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this._attachEvents()},setRoutes:function(a){this._routes=a},createRouteForURI:function(a){return new h(this._routes,a)},createRequest:function(a,b,c){return this._request=new g({uri:a,queryString:b,matchedRoute:c})},getCurrentRequest:function(){return this._request},
getCurrentPathname:function(){return this.pushStateEnabled?this._removeURIRoot(location.pathname):location.hash.replace("#","").split("?")[0]},getCurrentURI:function(){return this.pushStateEnabled?this._removeURIRoot(location.pathname)+location.search:location.hash.replace("#","")},getQueryString:function(){var a;return this.pushStateEnabled?location.search||null:(a=this.getCurrentURI().split("?")[1])?"?"+a:null},dispatch:function(){var a=this.getCurrentPathname(),b=this.createRouteForURI(a),c=this.getQueryString(),
a=this.createRequest(a,c,b.matchedRoute);this._invokeExits(a);this._actions=b.actions;this._invokeActions(a,b.options);this._exits=b.exits;this._dispatchingStarted||(this._dispatchingStarted=!0)},onURIChange:function(){this._silent||this.dispatch();this._silent=!1},onPopState:function(a){if(this._dispatchingStarted)this.onURIChange()},onClick:function(a){var b=a.target;this._matchesSelector(b);if(!a.metaKey&&!a.ctrlKey){for(;b&&!this._matchesSelector(b);)b=b.parentNode;b&&(a.preventDefault(),a=b.pathname,
"/"!==a.charAt(0)&&(a="/"+a),a=a.replace(this.root,""),this.navigate(a))}},navigate:function(a,b){b=b||{};var c=this.getCurrentRequest(),d=b.namedParams,e=b.queryParams;!d&&c&&(d=c.namedParams);this._actions=[];e&&(a+=this.serializeQueryParams(e));if(d)for(var f in d)d.hasOwnProperty(f)&&(a=a.replace(":"+f,encodeURIComponent(d[f])));b.silent&&(this._silent=!0);this.pushStateEnabled?(a=this._removeURIRoot(a),a=this.root+a,b.replace?history.replaceState("navigate","",a):history.pushState("navigate",
"",a),this.onURIChange()):b.replace?location.replace("#"+a):location.hash=a},refresh:function(){this.dispatch()},_attachEvents:function(){this.pushStateEnabled?f(window,"popstate",this.onPopState,this):f(window,"hashchange",this.onURIChange,this);f(document,"click",this.onClick,this)},_matchesSelector:function(a){var b=document.querySelectorAll(this.linkSelector),c=!1,d;for(d=0;d<b.length&&!c;d++)c=a===b[d];return c},_invokeExits:function(a){for(var b,c;this._exits.length;){b=this._exits.pop();c=
b.target;b=b.method;if(!(b in c))throw Error("Can't call exit "+b+" on target for uri "+a.uri);c[b].call(c)}},_invokeActions:function(a,b){for(var c,d;this._actions.length;){c=this._actions.shift();d=c.target;c=c.method;if(!(c in d))throw Error("Can't call action "+c+" on target for uri "+a.uri);d[c].call(d,a,b)}},_removeURIRoot:function(a){return a.replace(new RegExp("^"+this.root),"")},serializeQueryParams:function(a){var b=[],c,d;for(d in a)a.hasOwnProperty(d)&&(c=a[d],l(c)?k(c,function(a){b.push(encodeURIComponent(d)+
"[]="+encodeURIComponent(a))}):b.push(encodeURIComponent(d)+"="+encodeURIComponent(c)));return b="?"+b.join("&")}};return e});
