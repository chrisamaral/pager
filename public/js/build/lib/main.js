/** @jsx React.DOM */define(["../helpers/utils","../helpers/consts","../ext/aviator/main"],function(e,t,n){function u(e){return e.split("/")[2]||null}function a(e){var t=localStorage.getItem("pager."+pager.org.id+"."+e);pager[e]=t&&JSON.parse(t)||pager[e]}function f(){["urls","pagesEnabled","org","user","org","build"].forEach(function(e){var t=pager[e];t&&Modernizr.localstorage&&localStorage.setItem("pager."+pager.org.id+"."+e,JSON.stringify(t))})}Modernizr.touch&&React.initializeTouchEvents(!0),pager.constant=t;var r,i,s,o=location.pathname.split("/");return o[1]?(pager.org={id:o[1]},s=React.createClass({displayName:"PageList",navigateTo:function(e){var t=$(e.currentTarget).attr("href");t.charAt(0)==="/"&&t.substr(0,2)!=="//"&&(e.preventDefault(),pager.Aviator.navigate(t))},render:function(){var e={acw_admin:"fi-lock",pager_admin:"fi-wrench",console:"fi-map"},t=this.props.pagesEnabled.map(function(t){var n=e[t.id];return React.DOM.li({key:t.name},React.DOM.a({onClick:this.navigateTo,href:t.url},n?React.DOM.i({className:"the-icon "+n}):null,t.name))}.bind(this)),n=this.props.urls.base;return t.unshift(React.DOM.li({key:"usr.home"},React.DOM.a({href:n+"/home"},React.DOM.i({className:"the-icon fi-home"}),"Início"))),t.unshift(React.DOM.li({key:"placeholder"},React.DOM.label(null,"Menu"))),t.push(React.DOM.li({key:"usr"},React.DOM.label(null,"Usuário"))),t.push(React.DOM.li({key:"usr.settings"},React.DOM.a({href:n+"/user"},React.DOM.i({className:"the-icon fi-torso"}),"Configurações"))),t.push(React.DOM.li({key:"usr.logout"},React.DOM.a({href:n+"/logout"},React.DOM.i({className:"the-icon fi-x"}),"Logout"))),React.DOM.ul({className:"dropdown"},t)}}),i=React.createClass({displayName:"Root",getInitialState:function(){return{currentView:null,args:{},pagesEnabled:pager.pagesEnabled,urls:pager.urls,lastAppChange:Date.now()}},initializeApp:function(e){var t=u(e.uri),n=function(e){r=e,this.setState({lastAppChange:Date.now()})};this.setState({args:e.params,currentView:t}),require(["./"+t],n.bind(this))},setAppArgs:function(e){if(u(e.uri)!==this.state.currentView)return this.initializeApp(e);this.setState({args:e.params})},componentDidMount:function(){$(document).foundation();var e={goToMainPage:function(e){var t=pager.user.home||"console";n.navigate((e.uri+"/").replace("//","/")+t)},setupLayout:function(){}};n.setRoutes({target:e,"/*":"setupLayout","/:org":{"/":"goToMainPage","/console":{target:this,"/":"initializeApp","/:day/:locations":"setAppArgs"},"/admin":{target:this,"/":"initializeApp","/:view":"setAppArgs"}}}),n.dispatch(),pager.Aviator=n,$.get("/"+pager.org.id+"/api/pages").done(function(e){_.isArray(e)&&(pager.pagesEnabled=e.concat(),this.setState({pagesEnabled:e})),f()}.bind(this))},render:function(){var e=r;return React.DOM.div(null,React.DOM.div({className:"fixed"},React.DOM.nav({id:"MainTopBar",className:"top-bar","data-topbar":!0},React.DOM.ul({className:"title-area"},React.DOM.li({className:"name"},React.DOM.h1(null,React.DOM.a(null,"Pager"+(pager.org&&pager.org.name?" - "+pager.org.name:"")))),React.DOM.li({className:"toggle-topbar menu-icon"},React.DOM.a({href:"#"},React.DOM.span(null,"Menu")))),React.DOM.section({className:"top-bar-section"},React.DOM.ul({className:"right"},React.DOM.li({className:"has-dropdown"},React.DOM.a(null,"Menu"),s({urls:this.state.urls,pagesEnabled:this.state.pagesEnabled})))))),e&&e({args:this.state.args}))}}),pager.pagesEnabled=[],pager.components={},Modernizr.localstorage&&["urls","pagesEnabled","org","user"].forEach(function(e){a(e)}),$(document).ajaxError(function(e,t){if(t.status===401){if(pager.urls){location.href=pager.urls.base+"/login";return}location.reload(!0)}}),pager.org&&$.get("/"+pager.org.id+"/api").done(function(e){_.isObject(e)&&(_.merge(pager,e),pager.urls.ajax="/"+pager.org.id+"/api/",f())}).always(function(){pager.rootElem=React.renderComponent(i(null),document.getElementById("container"))}),pager):$("body").html("<h1>Erro</h1>")});