/** @jsx React.DOM */define(function(){var e=React.createClass({displayName:"UserSelector",render:function(){return React.DOM.select({defaultValue:this.props.selected||""},React.DOM.option({value:""},"########## Nenhum #########"),this.props.users.map(function(e){return React.DOM.option({key:e.id,value:e.id},e.name)}))}}),t=React.createClass({displayName:"EditWorkerForm",getInitialState:function(){return{locked:!1}},selectUser:function(e){var t=_.find(this.props.users,{id:e}),n=this.refs.workerName.getDOMNode();if(!t)return;n.name===""&&(n.value=t.name)},handleSubmit:function(e){e.preventDefault();var t={sys_id:this.refs.sys_id.getDOMNode().value,name:this.refs.name.getDOMNode().value,user_id:this.refs.user_id.getDOMNode().value,types:[]},n=$(e.currentTarget);n.find(":checkbox").each(function(){$(this).is(":checked")&&t.types.push($(this).val())}),this.props.worker._id&&(t._id=this.props.worker._id),this.setState({locked:!0}),this.props.saveWorker(t).always(function(){if(!this.isMounted())return;this.setState({locked:!1})}.bind(this)).done(function(){if(!this.isMounted())return;this.props.worker._id||(this.refs.sys_id.getDOMNode().value=this.props.worker.sys_id,this.refs.name.getDOMNode().value=this.props.worker.name,this.refs.user_id.getDOMNode().value=this.props.worker.user_id)}.bind(this)).fail(function(){if(!this.isMounted())return;$(this.getDOMNode()).prepend(React.renderComponentToStaticMarkup(React.DOM.div({"data-alert":!0,className:"radius alert alert-box"},"Erro, não foi possível salvar.",React.DOM.a({href:"#",className:"close"},"×")))).foundation()}.bind(this))},killMe:function(e){e.preventDefault(),this.props.deleteWorker(this.props.worker._id)},render:function(){var t=this.props.worker;return React.DOM.div({className:"panel"},React.DOM.form({onSubmit:this.handleSubmit},React.DOM.div({className:"row"},React.DOM.div({className:"medium-8 columns"},React.DOM.div({className:"row"},React.DOM.div({className:"medium-4 large-3 columns"},React.DOM.label(null,"Código",React.DOM.input({type:"text",placeholder:"0000",ref:"sys_id",defaultValue:t.sys_id}))),React.DOM.div({className:"medium-8 large-9 columns"},React.DOM.label(null,"Nome",React.DOM.input({type:"text",ref:"workerName",required:!0,placeholder:"Nome",ref:"name",defaultValue:t.name})))),React.DOM.div({className:"row"},React.DOM.div({className:"large-12 columns"},React.DOM.label(null,"Usuário Associado",e({ref:"user_id",selected:t.user_id,users:this.props.users,selectUser:this.selectUser})))),React.DOM.div({className:"row"},React.DOM.div({className:"large-12 columns text-right"},this.state.locked?React.DOM.strong(null,"Carregando..."):React.DOM.div({className:"AdmWBtRow"},React.DOM.button({className:"small buton success"},"Salvar"),this.props.deleteWorker?React.DOM.button({onClick:this.killMe,className:"small button alert"},"Remover"):null)))),React.DOM.div({className:"medium-4 columns"},this.props.availableTypes.map(function(e){var n=e.name,r=t._id||Math.random().toString(36).substr(2);return React.DOM.div({className:"row",key:n},React.DOM.div({className:"medium-12 columns"},React.DOM.input({id:"tagType"+n+r,type:"checkbox",value:n,defaultChecked:_.isArray(t.types)&&t.types.indexOf(n)>=0}),React.DOM.label({className:"textCapitalize",htmlFor:"tagType"+n+r},n)))})))))}}),n=React.createClass({displayName:"WorkerHeader",toggle:function(){this.props.toggleEditor(this.props.worker._id)},render:function(){return React.DOM.div({className:"row"},React.DOM.div({className:"medium-9 columns"},React.DOM.h5(null,React.DOM.strong(null,this.props.worker.name))),React.DOM.div({className:"medium-3 columns text-right"},this.props.worker.editable?React.DOM.a({onClick:this.toggle},React.DOM.i({className:"actionIco fi-x"}),"Cancelar"):React.DOM.a({onClick:this.toggle},React.DOM.i({className:"actionIco fi-pencil"}),"Editar")))}}),r=React.createClass({displayName:"WorkerList",render:function(){return React.DOM.div(null,this.props.workers.map(function(e){return React.DOM.div({className:"WorkerHeader",key:e._id},n({worker:e,toggleEditor:this.props.toggleEdit}),e.editable?t({users:this.props.users,worker:e,availableTypes:this.props.availableTypes,saveWorker:this.props.saveWorker,deleteWorker:this.props.deleteWorker}):null)}.bind(this)))}}),i=React.createClass({displayName:"Workers",getInitialState:function(){return{defaultWorker:{name:"",sys_id:"",user_id:""},workers:[],users:[],availableTypes:[]}},toggleEdit:function(e){var t=this.state.workers,n=_.find(t,{_id:e});if(!n)return;n.editable=!n.editable,this.setState({workers:t})},deleteWorker:function(e){return $.ajax({type:"DELETE",url:pager.urls.ajax+"admin/worker/"+e}).done(function(){if(!this.isMounted())return;var t=this.state.workers;_.remove(t,{_id:e}),this.setState({workers:t})}.bind(this))},saveWorker:function(e){return e.editable&&(e=_.omit(e,"editable")),$.ajax({type:"POST",url:pager.urls.ajax+"admin/worker"+(e._id?"/"+e._id:""),contentType:"application/json; charset=utf-8",data:JSON.stringify({worker:e})}).done(function(){if(!this.isMounted())return;if(e._id){var t=this.state.workers,n=_.find(t,{_id:e._id});if(!n)return;_.merge(n,e),this.setState({workers:t})}else this.reloadWorkers()}.bind(this))},setWorkers:function(e){if(!this.isMounted())return;this.setState({workers:e})},setUsers:function(e){if(!this.isMounted())return;this.setState({users:e})},reloadUsers:function(){$.get(pager.urls.ajax+"admin/users").done(this.setUsers)},reloadWorkers:function(){$.get(pager.urls.ajax+"admin/workers").done(this.setWorkers)},componentDidMount:function(){this.reloadUsers(),this.reloadWorkers(),$.get(pager.urls.ajax+"admin/types").done(function(e){this.setState({availableTypes:e})}.bind(this))},render:function(){return React.DOM.div(null,r({availableTypes:this.state.availableTypes,workers:this.state.workers,users:this.state.users,deleteWorker:this.deleteWorker,toggleEdit:this.toggleEdit,saveWorker:this.saveWorker}),t({availableTypes:this.state.availableTypes,saveWorker:this.saveWorker,worker:this.state.defaultWorker,users:this.state.users}))}});return i});