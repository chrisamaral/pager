(function(){function t(a){self.postMessage({type:"logMessage",data:a})}function y(a,b,c,d){var e=Math.PI/180*(c-a);b=Math.PI/180*(d-b);a=Math.sin(e/2)*Math.sin(e/2)+Math.cos(Math.PI/180*a)*Math.cos(Math.PI/180*c)*Math.sin(b/2)*Math.sin(b/2);return 12742*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}function r(a){a=_.isString(a)?a:""+a;return 2<=a.length?a:"0"+a}function z(a){return a.getFullYear()+"-"+r(a.getMonth()+1)+"-"+r(a.getDate())}function H(a){a=a||"clusterization";_.forEach(k,function(b){if(b.worker)delete b.minDistance;
else{var c=_.min(b.others,function(c){if(c.sharedWorkers.length){switch(a){case "clusterization":if(c.task.cluster&&(c.task.cluster===b.cluster||3<c.task.cluster.tasks.length)||c.distance>A)return;break;case "distribution":if(!c.task.worker||b.cluster&&-1===_.indexOf(b.cluster.candidateWorkers,c.task.worker)||-1===_.indexOf(_.map(b.candidateWorkers,function(a){return a.worker}),c.task.worker)||c.task.cluster&&c.task.cluster===b.cluster||c.distance>B)return}return c.distance}});b.minDistance=Infinity===
c?void 0:c}})}function I(a){var b=[];_.forEach(a,function(a){if(a.location){var d,e=function(b){return b._id===a._id||b._id===a._id},f=""+CryptoJS.SHA1((a.target?a.target._id:"")+a.address.address.toLowerCase());d=_.find(b,{addressPlusTargetIDSHA1:f});d?_.any(d.tasks,e)||(d.tasks.push(a),d.types.push(a.type),a.schedule&&(d.schedule=d.schedule||a.schedule,d.schedule.from=d.schedule.from<a.schedule.from?d.schedule.from:a.schedule.from,d.schedule.to=d.schedule.to<a.schedule.to?d.schedule.to:a.schedule.to)):
(d={addressPlusTargetIDSHA1:f,ref:a.ref,address:a.address,target:a.target,types:[a.type],tasks:[a]},a.schedule&&(d.schedule=a.schedule),a.location&&(d.location=a.location),b.push(d))}});m.log(a.length+" tasks grouped into "+b.length);return b}function C(a,b){b&&a.candidateWorkers||(a.candidateWorkers=a.candidateWorkers||[],_.forEach(q,function(b){var d=_.difference(a.types,b.types),e;var f=a.schedule,h=b.workShift;f&&h?(e=Math.min(f.to.getTime(),h.to.getTime()),f=Math.max(f.from.getTime(),h.from.getTime()),
e-=f):e=Infinity;d.length||e<a.duration||a.candidateWorkers.push({intersection:e,worker:b})}))}function D(a,b){return b.distance>A?a:null===a||void 0===a||a.distance<b.distance?b:a}function E(a){var b=a.schedule?new Date(a.schedule.from):null;b&&z(b)===u?(a.schedule.from=new Date(a.schedule.from),a.schedule.from.setSeconds(0,0),a.schedule.to=new Date(a.schedule.to),a.schedule.to.setSeconds(0,0)):delete a.schedule}function F(a){a=a.split(":");var b=u,c=new Date(b);z(c).replace(/\D/g,"")!==b.replace(/\D/g,
"")&&(c.setHours(0,0,0,0),c.setTime(c.getTime()+1440*s));c.setHours(parseInt(a[0],10),parseInt(a[1],10),0,0);return c}function J(){var a=[{from:"08:00",to:"17:00"},{from:"11:00",to:"20:00"},{from:"14:00",to:"23:00"}];_.forEach(q,function(b){var c;b.tasks=[];b.color="rgb("+_.random(30,200)+", "+_.random(30,200)+", "+_.random(30,200)+")";b.workShift||(c=_.cloneDeep(a[Math.floor(Math.random()*a.length)]),b.workShift=c);b.workShift.from=F(b.workShift.from);b.workShift.to=F(b.workShift.to)});_.forEach(k,
function(a){var c=0;a.others=a.others||{};E(a);C(a,!0);_.forEach(k,function(e){if(e.addressPlusTargetIDSHA1!==a.addressPlusTargetIDSHA1){E(e);C(e,!0);var f,d;d=function(a){return a.worker};f=y(a.location.lat,a.location.lng,e.location.lat,e.location.lng);d=_.intersection(a.candidateWorkers.map(d),e.candidateWorkers.map(d));d.length&&(a.others[e.addressPlusTargetIDSHA1]={distance:f,task:e,sharedWorkers:d},a.minDistance=D(a.minDistance,a.others[e.addressPlusTargetIDSHA1]),e.minDistance=D(e.minDistance,
a.others[e.addressPlusTargetIDSHA1]),c+=f)}});var d=_.keys(a.others).length;a.averageDistance=d?c/d:0})}function G(a){return r(a.getHours())+":"+r(a.getMinutes())}function K(){var a,b,c,d=new Date,e;_.forEach(q,function(f){b=f.workShift.from.getTime();c=f.workShift.to.getTime();a=Math.floor((c-b)/n);f.capacity=c-b;f.used=0;f.timeSlots=[];for(var h=0;h<a;h++)d.setTime(b+h*n),e={from:G(d),vAlloc:0},d.setTime(d.getTime()+n),e.to=G(d),f.timeSlots.push(e)})}function v(a,b){var c=(a.tasks||[]).concat(b),
d=a.used,e=_.map(a.timeSlots,function(a){return _.cloneDeep(a)});_.forEach(b,function(b){var c,g,l=b.schedule;g=a.workShift;l=l||g;c=Math.max(l.from.getTime(),g.from.getTime());g=Math.min(l.to.getTime(),g.to.getTime());l=Math.floor((c-a.workShift.from.getTime())/n);c=Math.floor((g-c)/n);g=l+c;var p=Math.floor(b.duration/n),k=c>=p;k||self.postMessage({type:"assertion",data:[k,c+" < "+p]});d+=b.duration;for(b=l;b<g;b++)if(e[b].vAlloc+=1/(c-p+1),!(b+p>g))for(l=b+1;l<b+p&&l<g;l++)e[l].vAlloc+=1/(c-p+
1)});if(_.any(e,function(a){return 1<a.vAlloc}))return!1;a.timeSlots=e;a.tasks=c;a.used=d;_.forEach(b,function(b){b.worker=a;b.cluster&&delete b.cluster});return!0}function w(a,b){return a.capacity-(b.duration+a.used)>=Math.min(0.3*a.capacity,L)}function M(a){function b(){var a=_.min(k,function(a){delete a.closestWorker;if(!a.worker){var b=_.min(a.candidateWorkers,function(b){var c=b.worker;if(!a.cluster||-1!==_.indexOf(a.cluster.candidateWorkers,c))return b.distance=y(a.location.lat,a.location.lng,
c.startPoint.lat,c.startPoint.lng),b.distance>N?void 0:b.distance});Infinity!==b&&(a.closestWorker=b.worker);return Infinity!==b?b.distance:void 0}});return Infinity!==a?a:null}function c(){var a=_.min(k,function(a){return!a.minDistance||a.worker||a.minDistance.distance>B?void 0:a.minDistance.distance});return Infinity!==a?a:null}t("Separando atividades...");var d,e,f,h,g;do if(f=d=e=null,H("distribution"),(e=b())||(d=c()),d||e)h=d?d.minDistance.task.worker:e.closestWorker,g=d||e,g.cluster?(f=g.cluster,
w(h,f)&&v(h,f.tasks)?_.pull(a,f):(f=_.findIndex(g.candidateWorkers,{worker:h}),0<=f&&g.candidateWorkers.splice(f,1))):w(h,g)&&v(h,[g])||(f=_.findIndex(g.candidateWorkers,{worker:h}),0<=f&&g.candidateWorkers.splice(f,1));while(d||e);_.forEach(k,function(a){a.cluster&&delete a.cluster;a.minDistance&&delete a.minDistance;a.others&&delete a.others;a.candidateWorkers&&delete a.candidateWorkers;a.worker&&delete a.worker;delete a.averageDistance});self.postMessage({type:"endOfTheLine",data:q});self.close()}
function O(a){a=a||[];var b;K();_.forEach(a,function(a){a.duration=_.reduce(a.tasks,function(a,b){return _.isNumber(a)?a+b.duration:a.duration+b.duration});a.candidateWorkers=_.intersection.apply(_,_.map(a.tasks,function(a){return a.candidateWorkers.map(function(a){return a.worker})}));var b=_.min(a.candidateWorkers,function(a){return a.used/a.capacity});b&&w(b,a)&&v(b,a.tasks)&&(a.worker=b)});b=a;a=_.filter(a,function(a){return void 0===a.worker});b.length!==a.length&&m.log(b.length+" clusters reduced to "+
a.length);M(a)}function P(a){m.log("Iniciando roteador...");m.log(a.day);m.log("Processando argumentos...");k=I(a.tasks);if(0===k.length)return self.close();q=a.workers;u=a.day;m.log("Calculando dura\u00e7\u00e3o de atividades...");self.postMessage({type:"fetchTypes",data:_.uniq(_.flatten(_.map(k,function(a){return a.types})))})}var k,q,u,x,m,s=6E4,A=5,B=10,N=100,n=5*s,L=45*s;m={log:function(){self.postMessage({type:"progressLog",data:1<arguments.length?arguments:arguments[0]})}};self.addEventListener("message",
function(a){switch(a.data.cmd){case "startRouter":P(a.data.data);break;case "parseTypes":x=a.data.data,_.forEach(k,function(a){var c=[];_.forEach(a.types,function(a){x[a]&&c.push(x[a])});a.duration=_.max(c)*s}),t("Processando agenda..."),J(),t("Iniciando c\u00e1lculos..."),O()}})})();
