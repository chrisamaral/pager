(function(){function h(e){self.postMessage({type:"logMessage",data:e})}function p(e,t){var n=Math.pow(10,t),r=Math.round(e*n)/n;return r}function d(e){return e>1?p(e,2)+"Km":p(e*1e3,2)+"m"}function v(e,t){e||self.postMessage({type:"assertion",data:[e,t]})}function m(e){return e*(Math.PI/180)}function g(e,t,n,r){var i=6371,s=m(n-e),o=m(r-t),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(m(e))*Math.cos(m(n))*Math.sin(o/2)*Math.sin(o/2),a=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),f=i*a;return f}function y(e){return e=_.isString(e)?e:""+e,e.length>=2?e:"0"+e}function b(e){return e.getFullYear()+"-"+y(e.getMonth()+1)+"-"+y(e.getDate())}function w(e){var t=new Date(e);return b(t).replace(/\D/g,"")!==e.replace(/\D/g,"")&&(t.setHours(0,0,0,0),t.setTime(t.getTime()+s*60*24)),t}function E(t){t=t||"clusterization",_.forEach(e,function(e){if(e.worker){delete e.minDistance;return}var n=_.min(e.others,function(n){if(!n.sharedWorkers.length)return undefined;switch(t){case"clusterization":if(n.task.cluster&&(n.task.cluster===e.cluster||n.task.cluster.tasks.length>3))return undefined;if(n.distance>o)return undefined;break;case"distribution":if(!n.task.worker)return undefined;if(e.cluster&&_.indexOf(e.cluster.candidateWorkers,n.task.worker)===-1)return undefined;if(_.indexOf(_.map(e.candidateWorkers,function(e){return e.worker}),n.task.worker)===-1)return undefined;if(n.task.cluster&&n.task.cluster===e.cluster)return undefined;if(n.distance>u)return undefined}return n.distance});e.minDistance=n===Infinity?undefined:n})}function S(e){var t=[];return _.forEach(e,function(e){if(!e.location)return;var n,r,i=function(t){return t._id===e._id||t._id===e._id},s=""+CryptoJS.SHA1((e.target?e.target._id:"")+e.address.address.toLowerCase()),n=_.find(t,{addressPlusTargetIDSHA1:s});if(!n)r={addressPlusTargetIDSHA1:s,ref:e.ref,address:e.address,target:e.target,types:[e.type],tasks:[e]},e.schedule&&(r.schedule=e.schedule),e.location&&(r.location=e.location),t.push(r);else{if(_.any(n.tasks,i))return;n.tasks.push(e),n.types.push(e.type),e.schedule&&(n.schedule=n.schedule||e.schedule,n.schedule.from=n.schedule.from<e.schedule.from?n.schedule.from:e.schedule.from,n.schedule.to=n.schedule.to<e.schedule.to?n.schedule.to:e.schedule.to)}}),i.log(e.length+" tasks grouped into "+t.length),t}function x(e){var t=e.schedule?new Date(e.schedule.from):null;return t&&b(t)===n}function T(e,t){var n,r;return!e||!t?Infinity:(n=Math.min(e.to.getTime(),t.to.getTime()),r=Math.max(e.from.getTime(),t.from.getTime()),n-r)}function N(e,n){if(n&&e.candidateWorkers)return;e.candidateWorkers=e.candidateWorkers||[],_.forEach(t,function(t){var n=_.difference(e.types,t.types),r=T(e.schedule,t.workShift);if(n.length||r<e.duration)return;e.candidateWorkers.push({intersection:r,worker:t})})}function C(e,t){return t.distance>o?e:e===null||e===undefined?t:e.distance<t.distance?t:e}function k(e){x(e)?(e.schedule.from=new Date(e.schedule.from),e.schedule.from.setSeconds(0,0),e.schedule.to=new Date(e.schedule.to),e.schedule.to.setSeconds(0,0)):delete e.schedule}function L(e){var t,r;return t=e.split(":"),r=w(n),r.setHours(parseInt(t[0],10),parseInt(t[1],10),0,0),r}function A(){var n=[{from:"08:00",to:"17:00"},{from:"11:00",to:"20:00"},{from:"14:00",to:"23:00"}];_.forEach(t,function(e){var t;e.tasks=[],e.color="rgb("+O()+", "+O()+", "+O()+")",e.workShift||(t=_.cloneDeep(n[Math.floor(Math.random()*n.length)]),e.workShift=t),e.workShift.from=L(e.workShift.from),e.workShift.to=L(e.workShift.to)}),_.forEach(e,function(t){var n=0;t.others=t.others||{},k(t),N(t,!0),_.forEach(e,function(e){if(e.addressPlusTargetIDSHA1===t.addressPlusTargetIDSHA1)return;k(e),N(e,!0);var r,i,s=function(e){return e.worker};r=g(t.location.lat,t.location.lng,e.location.lat,e.location.lng),i=_.intersection(t.candidateWorkers.map(s),e.candidateWorkers.map(s)),i.length&&(t.others[e.addressPlusTargetIDSHA1]={distance:r,task:e,sharedWorkers:i},t.minDistance=C(t.minDistance,t.others[e.addressPlusTargetIDSHA1]),e.minDistance=C(e.minDistance,t.others[e.addressPlusTargetIDSHA1]),n+=r)});var r=_.keys(t.others).length;t.averageDistance=r?n/r:0})}function O(){return _.random(30,200)}function M(e){return y(e.getHours())+":"+y(e.getMinutes())}function D(){var e,n,r,i=new Date,s;_.forEach(t,function(t){n=t.workShift.from.getTime(),r=t.workShift.to.getTime(),e=Math.floor((r-n)/f),t.capacity=r-n,t.used=0,t.timeSlots=[];for(var o=0;o<e;o++)i.setTime(n+o*f),s={from:M(i),vAlloc:0},i.setTime(i.getTime()+f),s.to=M(i),t.timeSlots.push(s)})}function P(e,t){return e=e||t,{from:Math.max(e.from.getTime(),t.from.getTime()),to:Math.min(e.to.getTime(),t.to.getTime())}}function H(e,t){var n=(e.tasks||[]).concat(t),r=e.used,i=_.map(e.timeSlots,function(e){return _.cloneDeep(e)});return _.forEach(t,function(t){var n=P(t.schedule,e.workShift),s=Math.floor((n.from-e.workShift.from.getTime())/f),o=Math.floor((n.to-n.from)/f),u=s+o,a=Math.floor(t.duration/f),l,c;v(o>=a,o+" < "+a),r+=t.duration;for(l=s;l<u;l++){i[l].vAlloc+=1/(o-a+1);if(l+a>u)continue;for(c=l+1;c<l+a&&c<u;c++)i[c].vAlloc+=1/(o-a+1)}}),_.any(i,function(e){return e.vAlloc>1})?!1:(e.timeSlots=i,e.tasks=n,e.used=r,_.forEach(t,function(t){t.worker=e,t.cluster&&delete t.cluster}),!0)}function B(e,t){return e.capacity-(t.duration+e.used)>=Math.min(e.capacity*.3,l)}function j(e,t,n){var r=t.cluster,i;_.forEach(r.tasks,function(t){t.cluster=e}),e.perimeter+=r.perimeter,e.tasks=e.tasks.concat(r.tasks),i=_.findIndex(n,function(e){return e===r}),n.splice(i,1)}function F(n){function r(){var t=_.min(e,function(e){delete e.closestWorker;if(e.worker)return undefined;var t=_.min(e.candidateWorkers,function(t){var n=t.worker;return e.cluster&&_.indexOf(e.cluster.candidateWorkers,n)===-1?undefined:(t.distance=g(e.location.lat,e.location.lng,n.startPoint.lat,n.startPoint.lng),t.distance>a?undefined:t.distance)});return t!==Infinity&&(e.closestWorker=t.worker),t!==Infinity?t.distance:undefined});return t!==Infinity?t:null}function i(){var t=_.min(e,function(e){return e.minDistance?e.worker?undefined:e.minDistance.distance>u?undefined:e.minDistance.distance:undefined});return t!==Infinity?t:null}h("Separando atividades...");var s,o,f,l,c,p;do{o=null,s=null,f=null,E("distribution"),(o=r())||(s=i());if(!s&&!o)continue;s?l=s.minDistance.task.worker:l=o.closestWorker,c=s||o;if(c.cluster)f=c.cluster,!B(l,f)||!H(l,f.tasks)?(p=_.findIndex(c.candidateWorkers,{worker:l}),p>=0&&c.candidateWorkers.splice(p,1)):_.pull(n,f);else if(!B(l,c)||!H(l,[c]))p=_.findIndex(c.candidateWorkers,{worker:l}),p>=0&&c.candidateWorkers.splice(p,1)}while(s||o);_.forEach(e,function(e){e.cluster&&delete e.cluster,e.minDistance&&delete e.minDistance,e.others&&delete e.others,e.candidateWorkers&&delete e.candidateWorkers,e.worker&&delete e.worker,delete e.averageDistance}),self.postMessage({type:"endOfTheLine",data:t}),self.close()}function I(e){e=e||[];var t;D(),_.forEach(e,function(e){e.duration=_.reduce(e.tasks,function(e,t){return _.isNumber(e)?e+t.duration:e.duration+t.duration}),e.candidateWorkers=_.intersection.apply(_,_.map(e.tasks,function(e){return e.candidateWorkers.map(function(e){return e.worker})}));var t=_.min(e.candidateWorkers,function(e){return e.used/e.capacity});t&&B(t,e)&&H(t,e.tasks)&&(e.worker=t)}),t=e,e=_.filter(e,function(e){return e.worker===undefined}),t.length!==e.length&&i.log(t.length+" clusters reduced to "+e.length),F(e)}function q(){function t(){var t=_.min(e,function(e){return e.cluster&&e.cluster.tasks.length>3||!e.minDistance?undefined:e.minDistance.distance});return t!==Infinity?t:null}var n=[],r,i,s;do{E(),r=t();if(!r)continue;r.cluster?i=r.cluster:(i={perimeter:0,tasks:[r],color:"rgb("+O()+", "+O()+", "+O()+")"},r.cluster=i,n.push(i)),i.perimeter+=r.minDistance.distance,s=r.minDistance.task,s.cluster?j(i,s,n):(s.cluster=i,i.tasks.push(s))}while(r);I(n)}function R(r){i.log("Iniciando roteador..."),i.log(r.day),i.log("Processando argumentos..."),e=S(r.tasks);if(e.length===0)return self.close();t=r.workers,n=r.day,i.log("Calculando duração de atividades..."),self.postMessage({type:"fetchTypes",data:_.uniq(_.flatten(_.map(e,function(e){return e.types})))})}var e,t,n,r,i,s=6e4,o=5,u=10,a=100,f=s*5,l=s*45,c=s*2;i={log:function(){var e=arguments.length>1?arguments:arguments[0];self.postMessage({type:"progressLog",data:e})}},self.addEventListener("message",function(t){switch(t.data.cmd){case"startRouter":R(t.data.data);break;case"parseTypes":r=t.data.data,_.forEach(e,function(e){var t=[];_.forEach(e.types,function(e){r[e]&&t.push(r[e])}),e.duration=_.max(t)*s}),h("Processando agenda..."),A(),h("Iniciando cálculos..."),I()}})})();