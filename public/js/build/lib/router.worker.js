(function(){function x(a,c,b,g){var e=Math.PI/180*(b-a);c=Math.PI/180*(g-c);a=Math.sin(e/2)*Math.sin(e/2)+Math.cos(Math.PI/180*a)*Math.cos(Math.PI/180*b)*Math.sin(c/2)*Math.sin(c/2);return 12742*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}function r(a){a=_.isString(a)?a:""+a;return 2<=a.length?a:"0"+a}function y(a){return a.getFullYear()+"-"+r(a.getMonth()+1)+"-"+r(a.getDate())}function G(a){a=a||"clusterization";_.forEach(k,function(c){if(c.worker)delete c.minDistance;else{var b=_.min(c.others,function(b){if(b.sharedWorkers.length){switch(a){case "clusterization":if(b.task.cluster&&
(b.task.cluster===c.cluster||3<b.task.cluster.tasks.length)||b.distance>z)return;break;case "distribution":if(!b.task.worker||c.cluster&&-1===_.indexOf(c.cluster.candidateWorkers,b.task.worker)||-1===_.indexOf(_.map(c.candidateWorkers,function(b){return b.worker}),b.task.worker)||b.task.cluster&&b.task.cluster===c.cluster||b.distance>A)return}return b.distance}});c.minDistance=Infinity===b?void 0:b}})}function H(a){var c=[];_.forEach(a,function(b){if(b.location){var a,e=function(a){return a.sys_id===
b.sys_id||a._id===b._id},d=""+CryptoJS.SHA1((b.target?b.target.sys_id:"")+b.address.address.toLowerCase());a=_.find(c,{id:d});a?_.any(a.tasks,e)||(a.tasks.push(b),a.types.push(b.type),b.schedule&&(a.schedule=a.schedule||b.schedule,a.schedule.from=a.schedule.from<b.schedule.from?a.schedule.from:b.schedule.from,a.schedule.to=a.schedule.to<b.schedule.to?a.schedule.to:b.schedule.to)):(a={id:d,ref:b.ref,address:b.address,target:b.target,types:[b.type],tasks:[b]},b.schedule&&(a.schedule=b.schedule),b.location&&
(a.location=b.location),c.push(a))}});m.log(a.length+" tasks grouped into "+c.length);return c}function B(a,c){c&&a.candidateWorkers||(a.candidateWorkers=a.candidateWorkers||[],_.forEach(q,function(b){var c=_.difference(a.types,b.types),e;var d=a.schedule,h=b.workShift;d&&h?(e=Math.min(d.to.getTime(),h.to.getTime()),d=Math.max(d.from.getTime(),h.from.getTime()),e-=d):e=Infinity;c.length||e<a.duration||a.candidateWorkers.push({intersection:e,worker:b})}))}function C(a,c){return c.distance>z?a:null===
a||void 0===a||a.distance<c.distance?c:a}function D(a){var c=a.schedule?new Date(a.schedule.from):null;c&&y(c)===t?(a.schedule.from=new Date(a.schedule.from),a.schedule.from.setSeconds(0,0),a.schedule.to=new Date(a.schedule.to),a.schedule.to.setSeconds(0,0)):delete a.schedule}function E(a){a=a.split(":");var c=t,b=new Date(c);y(b).replace(/\D/g,"")!==c.replace(/\D/g,"")&&(b.setHours(0,0,0,0),b.setTime(b.getTime()+1440*s));b.setHours(parseInt(a[0],10),parseInt(a[1],10),0,0);return b}function I(){var a=
[{from:"08:00",to:"17:00"},{from:"11:00",to:"20:00"},{from:"14:00",to:"23:00"}],c={lat:-22.904356,lng:-43.18939};_.forEach(q,function(b){var g;b.tasks=[];b.color="rgb("+_.random(30,200)+", "+_.random(30,200)+", "+_.random(30,200)+")";b.startPoint=b.startPoint||c;b.workShift||(g=_.cloneDeep(a[Math.floor(Math.random()*a.length)]),b.workShift=g);b.workShift.from=E(b.workShift.from);b.workShift.to=E(b.workShift.to)});_.forEach(k,function(a){var c=0;a.others=a.others||{};D(a);B(a,!0);_.forEach(k,function(d){if(d.id!==
a.id){D(d);B(d,!0);var e,f;f=function(a){return a.worker};e=x(a.location.lat,a.location.lng,d.location.lat,d.location.lng);f=_.intersection(a.candidateWorkers.map(f),d.candidateWorkers.map(f));f.length&&(a.others[d.id]={distance:e,task:d,sharedWorkers:f},a.minDistance=C(a.minDistance,a.others[d.id]),d.minDistance=C(d.minDistance,a.others[d.id]),c+=e)}});var e=_.keys(a.others).length;a.averageDistance=e?c/e:0})}function F(a){return r(a.getHours())+":"+r(a.getMinutes())}function J(){var a,c,b,g=new Date,
e;_.forEach(q,function(d){c=d.workShift.from.getTime();b=d.workShift.to.getTime();a=Math.floor((b-c)/n);d.capacity=b-c;d.used=0;d.timeSlots=[];for(var h=0;h<a;h++)g.setTime(c+h*n),e={from:F(g),vAlloc:0},g.setTime(g.getTime()+n),e.to=F(g),d.timeSlots.push(e)})}function u(a,c){var b=(a.tasks||[]).concat(c),g=a.used,e=_.map(a.timeSlots,function(a){return _.cloneDeep(a)});_.forEach(c,function(b){var c,f,l=b.schedule;f=a.workShift;l=l||f;c=Math.max(l.from.getTime(),f.from.getTime());f=Math.min(l.to.getTime(),
f.to.getTime());l=Math.floor((c-a.workShift.from.getTime())/n);c=Math.floor((f-c)/n);f=l+c;var p=Math.floor(b.duration/n),k=c>=p;k||self.postMessage({type:"assertion",data:[k,c+" < "+p]});g+=b.duration;for(b=l;b<f;b++)if(e[b].vAlloc+=1/(c-p+1),!(b+p>f))for(l=b+1;l<b+p&&l<f;l++)e[l].vAlloc+=1/(c-p+1)});if(_.any(e,function(a){return 1<a.vAlloc}))return!1;a.timeSlots=e;a.tasks=b;a.used=g;_.forEach(c,function(b){b.worker=a;b.cluster&&delete b.cluster});return!0}function v(a,c){return a.capacity-(c.duration+
a.used)>=Math.min(0.3*a.capacity,K)}function L(a){function c(){var a=_.min(k,function(a){delete a.closestWorker;if(!a.worker){var b=_.min(a.candidateWorkers,function(b){var c=b.worker;if(!a.cluster||-1!==_.indexOf(a.cluster.candidateWorkers,c))return b.distance=x(a.location.lat,a.location.lng,c.startPoint.lat,c.startPoint.lng),b.distance>M?void 0:b.distance});Infinity!==b&&(a.closestWorker=b.worker);return Infinity!==b?b.distance:void 0}});return Infinity!==a?a:null}function b(){var a=_.min(k,function(a){return!a.minDistance||
a.worker||a.minDistance.distance>A?void 0:a.minDistance.distance});return Infinity!==a?a:null}var g,e,d,h,f;do if(d=g=e=null,G("distribution"),(e=c())||(g=b()),g||e)h=g?g.minDistance.task.worker:e.closestWorker,f=g||e,f.cluster?(d=f.cluster,v(h,d)&&u(h,d.tasks)?_.pull(a,d):(d=_.findIndex(f.candidateWorkers,{worker:h}),0<=d&&f.candidateWorkers.splice(d,1))):v(h,f)&&u(h,[f])||(d=_.findIndex(f.candidateWorkers,{worker:h}),0<=d&&f.candidateWorkers.splice(d,1));while(g||e);_.forEach(k,function(a){a.cluster&&
delete a.cluster;a.minDistance&&delete a.minDistance;a.others&&delete a.others;a.candidateWorkers&&delete a.candidateWorkers;a.worker&&delete a.worker;delete a.averageDistance});self.postMessage({type:"endOfTheLine",data:q});self.close()}function N(a){a=a||[];var c;J();_.forEach(a,function(a){a.duration=_.reduce(a.tasks,function(a,b){return _.isNumber(a)?a+b.duration:a.duration+b.duration});a.candidateWorkers=_.intersection.apply(_,_.map(a.tasks,function(a){return a.candidateWorkers.map(function(a){return a.worker})}));
var c=_.min(a.candidateWorkers,function(a){return a.used/a.capacity});c&&v(c,a)&&u(c,a.tasks)&&(a.worker=c)});c=a;a=_.filter(a,function(a){return void 0===a.worker});c.length!==a.length&&m.log(c.length+" clusters reduced to "+a.length);L(a)}function O(a){m.log("Iniciando roteador...");m.log(a.day);m.log("Processando argumentos...");k=H(a.tasks);if(0===k.length)return self.close();q=a.workers;t=a.day;m.log("Calculando dura\u00e7\u00e3o de atividades...");self.postMessage({type:"fetchTypes",data:_.uniq(_.flatten(_.map(k,
function(a){return a.types})))})}var k,q,t,w,m,s=6E4,z=5,A=10,M=100,n=5*s,K=45*s;m={log:function(){self.postMessage({type:"progressLog",data:1<arguments.length?arguments:arguments[0]})}};self.addEventListener("message",function(a){switch(a.data.cmd){case "startRouter":O(a.data.data);break;case "parseTypes":w=a.data.data,_.forEach(k,function(a){var b=[];_.forEach(a.types,function(a){w[a]&&b.push(w[a])});a.duration=_.max(b)*s}),m.log("Iniciando c\u00e1lculos..."),I(),N()}})})();
