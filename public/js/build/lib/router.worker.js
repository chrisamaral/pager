(function(){function z(a,c,b,d){var e=Math.PI/180*(b-a);c=Math.PI/180*(d-c);a=Math.sin(e/2)*Math.sin(e/2)+Math.cos(Math.PI/180*a)*Math.cos(Math.PI/180*b)*Math.sin(c/2)*Math.sin(c/2);return 12742*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}function s(a){a=_.isString(a)?a:""+a;return 2<=a.length?a:"0"+a}function A(a){return a.getFullYear()+"-"+s(a.getMonth()+1)+"-"+s(a.getDate())}function B(a){a=a||"clusterization";_.forEach(k,function(c){if(c.worker)delete c.minDistance;else{var b=_.min(c.others,function(b){if(b.sharedWorkers.length){switch(a){case "clusterization":if(b.task.cluster&&
(b.task.cluster===c.cluster||4<b.task.cluster.tasks.length)||b.distance>C)return;break;case "distribution":if(!b.task.worker||c.cluster&&-1===_.indexOf(c.cluster.candidateWorkers,b.task.worker)||-1===_.indexOf(_.map(c.candidateWorkers,function(a){return a.worker}),b.task.worker)||b.task.cluster&&b.task.cluster===c.cluster||b.distance>u)return}return b.distance}});c.minDistance=Infinity===b?void 0:b}})}function J(a){var c=[];_.forEach(a,function(a){if(a.location){var d,e=function(f){return f.sys_id===
a.sys_id||f._id===a._id},f=""+CryptoJS.SHA1((a.target?a.target.sys_id:"")+a.address.address.toLowerCase());d=_.find(c,{id:f});d?_.any(d.tasks,e)||(d.tasks.push(a),d.types.push(a.type),a.schedule&&(d.schedule=d.schedule||a.schedule,d.schedule.from=d.schedule.from<a.schedule.from?d.schedule.from:a.schedule.from,d.schedule.to=d.schedule.to<a.schedule.to?d.schedule.to:a.schedule.to)):(d={id:f,ref:a.ref,address:a.address,target:a.target,types:[a.type],tasks:[a]},a.schedule&&(d.schedule=a.schedule),a.location&&
(d.location=a.location),c.push(d))}});m.log(a.length+" tasks grouped into "+c.length);return c}function D(a,c){c&&a.candidateWorkers||(a.candidateWorkers=a.candidateWorkers||[],_.forEach(n,function(b){var c=_.difference(a.types,b.types),e;var f=a.schedule,h=b.workShift;f&&h?(e=Math.min(f.to.getTime(),h.to.getTime()),f=Math.max(f.from.getTime(),h.from.getTime()),e-=f):e=Infinity;c.length||e<a.duration||a.candidateWorkers.push({intersection:e,worker:b})}))}function E(a,c){return c.distance>C?a:null===
a||void 0===a||a.distance<c.distance?c:a}function F(a){var c=a.schedule?new Date(a.schedule.from):null;c&&A(c)===v?(a.schedule.from=new Date(a.schedule.from),a.schedule.from.setSeconds(0,0),a.schedule.to=new Date(a.schedule.to),a.schedule.to.setSeconds(0,0)):delete a.schedule}function G(a){a=a.split(":");var c=v,b=new Date(c);A(b).replace(/\D/g,"")!==c.replace(/\D/g,"")&&(b.setHours(0,0,0,0),b.setTime(b.getTime()+1440*t));b.setHours(parseInt(a[0],10),parseInt(a[1],10),0,0);return b}function K(){var a=
[{from:"08:00",to:"17:00"},{from:"11:00",to:"20:00"},{from:"14:00",to:"23:00"}],c=0,b=0,d=0,e;_.forEach(k,function(a){c+=a.location.lat;b+=a.location.lng;d++});e={lat:c/d,lng:b/d};_.forEach(n,function(f){f.tasks=[];f.color="rgb("+p()+", "+p()+", "+p()+")";var c=_.cloneDeep(a[Math.floor(Math.random()*a.length)]),b=_.random(1,10),d=0===Date.now()%2?-1:1;f.startingPoint=e;f.startingPoint.lat+=0.001*b*d;f.startingPoint.lng+=0.001*b*d;f.workShift=c;f.workShift.from=G(c.from);f.workShift.to=G(c.to)});_.forEach(k,
function(a){var c=0;a.others=a.others||{};F(a);D(a,!0);_.forEach(k,function(b){if(b.id!==a.id){F(b);D(b,!0);var d,e;e=function(a){return a.worker};d=z(a.location.lat,a.location.lng,b.location.lat,b.location.lng);e=_.intersection(a.candidateWorkers.map(e),b.candidateWorkers.map(e));a.others[b.id]={distance:d,task:b,sharedWorkers:e};e.length&&(a.minDistance=E(a.minDistance,a.others[b.id]),b.minDistance=E(b.minDistance,a.others[b.id]));c+=d}});var b=_.keys(a.others).length;a.averageDistance=b?c/b:0})}
function p(){return _.random(30,200)}function H(a){return s(a.getHours())+":"+s(a.getMinutes())}function L(){var a,c,b,d=new Date,e;_.forEach(n,function(f){c=f.workShift.from.getTime();b=f.workShift.to.getTime();a=Math.floor((b-c)/r);f.capacity=b-c;f.used=0;f.timeSlots=[];for(var h=0;h<a;h++)d.setTime(c+h*r),e={from:H(d),vAlloc:0},d.setTime(d.getTime()+r),e.to=H(d),f.timeSlots.push(e)})}function w(a,c){var b=(a.tasks||[]).concat(c),d=a.used,e=_.map(a.timeSlots,function(a){return _.cloneDeep(a)});
_.forEach(c,function(b){var c,g,l=b.schedule;g=a.workShift;l=l||g;c=Math.max(l.from.getTime(),g.from.getTime());g=Math.min(l.to.getTime(),g.to.getTime());l=Math.floor((c-a.workShift.from.getTime())/r);c=Math.floor((g-c)/r);g=l+c;var q=Math.floor(b.duration/r),k=c>=q;k||self.postMessage({type:"assertion",data:[k,c+" < "+q]});d+=b.duration;for(b=l;b<g;b++)if(e[b].vAlloc+=1/(c-q+1),!(b+q>g))for(l=b+1;l<b+q&&l<g;l++)e[l].vAlloc+=1/(c-q+1)});if(_.any(e,function(a){return 1<a.vAlloc}))return!1;a.timeSlots=
e;a.tasks=b;a.used=d;return!0}function M(a,c,b){var d=c.cluster;_.forEach(d.tasks,function(b){b.cluster=a});a.perimeter+=d.perimeter;a.tasks=a.tasks.concat(d.tasks);c=_.findIndex(b,function(a){return a===d});b.splice(c,1)}function N(a){function c(){var a=_.min(k,function(a){delete a.closestWorker;if(!a.worker){var b=_.min(a.candidateWorkers,function(b){var c=b.worker;if(!a.cluster||-1!==_.indexOf(a.cluster.candidateWorkers,c))return b.distance=z(a.location.lat,a.location.lng,c.startingPoint.lat,c.startingPoint.lng),
b.distance>u?void 0:b.distance});Infinity!==b&&(a.closestWorker=b.worker);return Infinity!==b?b.distance:void 0}});return Infinity!==a?a:null}function b(){var a=_.min(k,function(a){return!a.minDistance||a.worker||a.minDistance.distance>u?void 0:a.minDistance.distance});return Infinity!==a?a:null}var d,e,f,h,g;do if(f=d=e=null,B("distribution"),(d=b())||(e=c()),d||e){h=d?d.minDistance.task.worker:e.closestWorker;g=d||e;if(g.cluster){f=g.cluster;if(!(h.capacity-(f.duration+h.used)>=x&&w(h,f.tasks))){f=
_.findIndex(g.candidateWorkers,{worker:h});0<=f&&g.candidateWorkers.splice(f,1);continue}g.cluster.tasks.forEach(function(a){a.worker=h;delete a.cluster});h.tasks=h.tasks.concat(f.tasks);_.pull(a,f)}else{if(!(h.capacity-(g.duration+h.used)>=x&&w(h,[g]))){f=_.findIndex(g.candidateWorkers,{worker:h});0<=f&&g.candidateWorkers.splice(f,1);continue}h.tasks.push(g);g.worker=h}O(a)}while(d||e);_.forEach(k,function(a){a.cluster&&delete a.cluster;a.minDistance&&delete a.minDistance;a.others&&delete a.others;
a.candidateWorkers&&delete a.candidateWorkers;a.worker&&delete a.worker;delete a.averageDistance});self.postMessage({type:"endOfTheLine",data:_.filter(n,function(a){return a.tasks.length})});self.close()}function I(a){return{lines:_.map(_.filter(n,function(a){return 1<a.tasks.length}),function(a){var b={color:a.color,points:_.map(a.tasks,function(a){return a.location})};a.startingPoint&&b.points.length&&b.points.unshift(a.startingPoint);return b}),polygons:_.map(_.filter(a,function(a){return 1<a.tasks.length}),
function(a){return{color:a.color,points:_.map(a.tasks,function(a){return a.location})}})}}function P(a){var c;L();_.forEach(a,function(a){a.duration=_.reduce(a.tasks,function(a,b){return _.isNumber(a)?a+b.duration:a.duration+b.duration});a.candidateWorkers=_.intersection.apply(_,_.map(a.tasks,function(a){return a.candidateWorkers.map(function(a){return a.worker})}));var c=_.min(a.candidateWorkers,function(a){return a.used/a.capacity});c&&c.capacity-(a.duration+c.used)>=x&&w(c,a.tasks)&&(a.worker=
c,_.forEach(a.tasks,function(c){c.worker=a.worker;delete c.cluster}))});c=a;a=_.filter(a,function(a){return void 0===a.worker});m.log(c.length+" clusters reduced to "+a.length);self.postMessage({type:"drawGraph",data:I(a)});N(a)}function Q(){function a(){var a=_.min(k,function(a){return a.cluster&&4<a.cluster.tasks.length||!a.minDistance?void 0:a.minDistance.distance});return Infinity!==a?a:null}var c=[],b,d,e;do if(B(),b=a())b.cluster?d=b.cluster:(d={perimeter:0,tasks:[b],color:"rgb("+p()+", "+p()+
", "+p()+")"},b.cluster=d,c.push(d)),d.perimeter+=b.minDistance.distance,e=b.minDistance.task,e.cluster?M(d,e,c):(e.cluster=d,d.tasks.push(e));while(b);P(c)}function R(a){m.log("Iniciando roteador...");m.log(a.day);m.log("Processando argumentos...");k=J(a.tasks);k.length?(n=a.workers,v=a.day,m.log("Calculando dura\u00e7\u00e3o de atividades..."),self.postMessage({type:"fetchTypes",data:_.uniq(_.flatten(_.map(k,function(a){return a.types})))})):self.close()}var k,n,v,y,m,t=6E4,C=5,u=7,r=5*t,x=30*t;
m={log:function(){self.postMessage({type:"progressLog",data:1<arguments.length?arguments:arguments[0]})}};var O=_.debounce(function(a){self.postMessage({type:"drawGraph",data:I(a)})},500);self.addEventListener("message",function(a){switch(a.data.cmd){case "startRouter":R(a.data.data);break;case "parseTypes":y=a.data.data,_.forEach(k,function(a){var b=[];_.forEach(a.types,function(a){y[a]&&b.push(y[a])});a.duration=_.max(b)*t}),m.log("Iniciando c\u00e1lculos..."),K(),Q()}})})();
