define(["./../lib/main","../ext/aviator/main","./console.queue","./console.tasks"],function(e,k,q,r){function f(){this.data={};this.component=null}var l,m,n,g,d,p;LazyLoad.css(["/css/console.css"]);d=React.createClass({displayName:"UserLink",render:function(){return this.props.user.url?React.DOM.a({target:"_blank",title:this.props.user.full_name,href:this.props.user.url},this.props.user.short_name):React.DOM.strong({title:this.props.user.full_name},this.props.user.short_name)}});p=React.createClass({displayName:"ObjectLink",
render:function(){return React.DOM.span(null,this.props.object.adj?" "+this.props.object.adj:null,React.DOM.span(null," "),this.props.object.url?React.DOM.a({target:"_blank",href:this.props.object.url},this.props.object.name):React.DOM.strong(null,this.props.object.name))}});AttrItem=React.createClass({displayName:"AttrItem",render:function(){var a=this.props.attr,b=React.addons.classSet({"main-attr":3===a.relevance,"important-attr":2===a.relevance}),c=3===a.relevance&&_.isString(a.value)?a.value.toUpperCase():
a.value,h=3!==a.relevance&&a.descr;return React.DOM.tr({className:b},h?React.DOM.td(null,a.descr):null,React.DOM.td({colSpan:3!==a.relevance&&h?1:2,title:!h&&a.descr?a.descr:""},a.url?React.DOM.a({href:a.url,target:"_blank"},c):c))}});AttrTable=React.createClass({displayName:"AttrTable",render:function(){var a=_.filter(this.props.attrs,{relevance:3}).concat(_.filter(this.props.attrs,{relevance:2})).concat(_.filter(this.props.attrs,function(a){return!a.relevance||1>=a.relevance}));return React.DOM.table({className:"attr-table"},
React.DOM.tbody(null,a.map(function(a,c){return AttrItem({key:c,attr:a})})))}});l=React.createClass({displayName:"LeftPanel",getInitialState:function(){return{visible:!0,lastUpdate:Date.now()}},togglePanel:function(){this.setState({visible:!this.state.visible})},componentDidMount:function(){g=_.throttle(function(){this.setState({lastUpdate:Date.now})}.bind(this),300);$(window).resize(g)},componentWillUnmount:function(){$(window).off("resize",g)},render:function(){var a={},a={height:$(window).height()-
$(".tab-bar").outerHeight()};this.state.visible||(a.display="none");return React.DOM.nav({id:"LeftPanel",style:a},React.DOM.div({id:"LeftPanelWrapper"},this.props.pending.length?q({items:this.props.pending}):null,r({queries:this.props.queries,setQueries:this.props.setQueries})))}});m=React.createClass({displayName:"RightPanel",render:function(){return React.DOM.main({id:"RightPanel"},"Direita")}});n=React.createClass({displayName:"Console",getInitialState:function(){var a=this.props.args.locations?
this.props.args.locations:[],a=a?_.isString(a)?a:_.isArray(a)?a.join(","):"":"";return{day:this.props.args.day?this.props.args.day:(new Date).toYMD(),locations:a}},componentDidMount:function(){this.putArgs()},putArgs:function(){var a=[e.org.id,"console",this.state.day];this.state.locations.length&&a.push(this.state.locations);a="/"+a.join("/");a!==k.getCurrentURI()&&k.navigate(a)},setQueries:function(a){this.props.lib.set("queries",a)},render:function(){return React.DOM.div({id:"Console"},l({pending:this.props.lib.data.pending,
queries:this.props.lib.data.queries,setQueries:this.setQueries}),m(null))}});f.prototype.put=function(){Modernizr.localstorage&&localStorage.setItem("queries",JSON.stringify(this.data.queries.slice(1)));this.component.setProps({lib:this})};f.prototype.set=function(a,b){"queries"===a&&(b=b.filter(function(a,b){return 0===b||a.tasks&&a.tasks.length}));this.data[a]=b;this.put()};f.prototype.init=function(a,b){var c;this.data={pending:[],queries:[{name:"Agenda",tasks:[],query:{schedule:[(new Date).toYMD()]}}],
workers:[]};if(Modernizr.localstorage){try{c=JSON.parse(localStorage.getItem("queries"))}catch(d){console.log(d)}this.data.queries=c&&c.length?this.data.queries.concat(c):this.data.queries}this.data.queries.forEach(function(a,b){$.get("/"+e.org.id+"/api/console/tasks",a.query).done(function(b){_.isArray(b)&&(a.tasks=b,this.put())}.bind(this))}.bind(this));this.component=a;b(this);$.get("/json/console.pending.json").done(function(a){this.data.pending=a;this.put()}.bind(this))};_.merge(e.components,
{UserLink:d,ObjectLink:p,AttrTable:AttrTable});d=new f;e.isDev&&(e.console=d);return{component:n,librarian:d}});
