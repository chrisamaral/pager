define(["../ext/aviator/main","./console.queue","./console.tasks"],function(h,p,q){function e(){this.data={};this.component=null}var k,l,m,f,d,n;LazyLoad.css(["/css/console.css"]);d=React.createClass({displayName:"UserLink",render:function(){return this.props.user.url?React.DOM.a({target:"_blank",title:this.props.user.full_name,href:this.props.user.url},this.props.user.short_name):React.DOM.strong({title:this.props.user.full_name},this.props.user.short_name)}});n=React.createClass({displayName:"ObjectLink",
render:function(){return React.DOM.span(null,this.props.object.adj?" "+this.props.object.adj:null,React.DOM.span(null," "),this.props.object.url?React.DOM.a({target:"_blank",href:this.props.object.url},this.props.object.name):React.DOM.strong(null,this.props.object.name))}});AttrItem=React.createClass({displayName:"AttrItem",render:function(){var a=this.props.attr,c=React.addons.classSet({"main-attr":3===a.relevance,"important-attr":2===a.relevance}),b=3===a.relevance&&_.isString(a.value)?a.value.toUpperCase():
a.value,g=3!==a.relevance&&a.descr;return React.DOM.tr({className:c},g?React.DOM.td(null,a.descr):null,React.DOM.td({colSpan:3!==a.relevance&&g?1:2,title:!g&&a.descr?a.descr:""},a.url?React.DOM.a({href:a.url,target:"_blank"},b):b))}});AttrTable=React.createClass({displayName:"AttrTable",render:function(){var a=_.filter(this.props.attrs,{relevance:3}).concat(_.filter(this.props.attrs,{relevance:2})).concat(_.filter(this.props.attrs,function(a){return!a.relevance||1>=a.relevance}));return React.DOM.table({className:"attr-table"},
React.DOM.tbody(null,a.map(function(a,b){return AttrItem({key:b,attr:a})})))}});k=React.createClass({displayName:"LeftPanel",getInitialState:function(){return{visible:!0,lastUpdate:Date.now()}},togglePanel:function(){this.setState({visible:!this.state.visible})},componentDidMount:function(){f=_.throttle(function(){this.setState({lastUpdate:Date.now})}.bind(this),300);$(window).resize(f)},componentWillUnmount:function(){$(window).off("resize",f)},render:function(){var a={},a={height:$(window).height()-
$(".tab-bar").outerHeight()};this.state.visible||(a.display="none");return React.DOM.nav({id:"LeftPanel",style:a},React.DOM.div({id:"LeftPanelWrapper"},this.props.pending.length?p({items:this.props.pending}):null,q({queries:this.props.queries,setQueries:this.props.setQueries})))}});l=React.createClass({displayName:"RightPanel",render:function(){return React.DOM.main({id:"RightPanel"},"Direita")}});m=React.createClass({displayName:"Console",getInitialState:function(){var a=this.props.args.locations?
this.props.args.locations:[],a=a?_.isString(a)?a:_.isArray(a)?a.join(","):"":"";return{day:this.props.args.day?this.props.args.day:(new Date).toYMD(),locations:a}},componentDidMount:function(){this.putArgs()},putArgs:function(){var a=[pager.org.id,"console",this.state.day];this.state.locations.length&&a.push(this.state.locations);a="/"+a.join("/");a!==h.getCurrentURI()&&h.navigate(a)},setQueries:function(a){this.props.lib.set("queries",a)},render:function(){return React.DOM.div({id:"Console"},k({pending:this.props.lib.data.pending,
queries:this.props.lib.data.queries,setQueries:this.setQueries}),l(null))}});e.prototype.put=function(){Modernizr.localstorage&&localStorage.setItem("pager.console.queries",JSON.stringify(this.data.queries.filter(function(a){return"Agenda"!==a.name}).map(function(a){a=_.cloneDeep(a);a.tasks=[];return a})));this.component.setProps({lib:this})};e.prototype.set=function(a,c){"queries"===a&&(c=c.filter(function(a,c){return"Agenda"===a.name||a.tasks&&a.tasks.length}));this.data[a]=c;this.put()};e.prototype.init=
function(a,c){var b;this.data={pending:[],queries:[{name:"Agenda",tasks:[],query:{schedule:[(new Date).toYMD()]}}],workers:[]};if(Modernizr.localstorage){try{b=JSON.parse(localStorage.getItem("pager.console.queries"))}catch(d){console.log(d)}this.data.queries=b&&b.length?this.data.queries.concat(b):this.data.queries}this.data.queries.forEach(function(a,b){$.get("/"+pager.org.id+"/api/console/tasks",a.query).done(function(b){_.isArray(b)&&(a.tasks=b,this.put())}.bind(this))}.bind(this));this.component=
a;c(this);$.get("/json/console.pending.json").done(function(a){if(_.isString(a))try{a=JSON.parse(a)}catch(b){console.log(b),a=[]}this.data.pending=a;this.put()}.bind(this))};_.merge(pager.components,{UserLink:d,ObjectLink:n,AttrTable:AttrTable});d=new e;pager.isDev&&(pager.console=d);return{component:m,librarian:d}});
