define(["../ext/aviator/main", "./component.DateInput", "./console.queue", "./console.tasks", "./console.map", "./console.schedule", "../helpers/utils.js", "../ext/strftime", "../lib/console.component.schedule.js", "../lib/console.component.router.js", "../lib/console.component.map.js", "../lib/console.component.queries.js"],function(h,y,z,A,B,C,l,g,k,D,E,F){var m,n,p,q,r,s,t,u,v,w;LazyLoad.css(["/css/console.css"]);l=React.createClass({displayName:"UserLink",render:function(){return this.props.user.url?React.DOM.a({target:"_blank",
title:this.props.user.full_name,href:this.props.user.url},this.props.user.short_name):React.DOM.strong({title:this.props.user.full_name},this.props.user.short_name)}});w=React.createClass({displayName:"ObjectLink",render:function(){return React.DOM.span(null,this.props.object.adj?" "+this.props.object.adj:null,React.DOM.span(null," "),this.props.object.url?React.DOM.a({target:"_blank",href:this.props.object.url},this.props.object.name):React.DOM.strong(null,this.props.object.name))}});v=React.createClass({displayName:"AttrItem",
toggleTb:function(){$(this.getDOMNode()).closest("table").find("tbody>tr").not(".main-attr").toggle()},render:function(){var a=this.props.attr,b=React.addons.classSet({"main-attr":3===a.relevance,"important-attr":2===a.relevance}),e=3===a.relevance&&_.isString(a.value)?a.value.toUpperCase():a.value,f=3!==a.relevance&&a.descr;return React.DOM.tr({className:b,onClick:3===a.relevance?this.toggleTb:null},f?React.DOM.td(null,a.descr):null,React.DOM.td({colSpan:3!==a.relevance&&f?1:2,title:!f&&a.descr?
a.descr:""},a.url?React.DOM.a({href:a.url,target:"_blank"},e):e))}});u=React.createClass({displayName:"AttrTable",render:function(){var a=_.filter(this.props.attrs,{relevance:3}).concat(_.filter(this.props.attrs,{relevance:2})).concat(_.filter(this.props.attrs,function(a){return!a.relevance||1>=a.relevance}));return React.DOM.table({className:"attr-table"},React.DOM.tbody(null,a.map(function(a,e){return v({key:e,attr:a})})))}});r=React.createClass({displayName:"RouterWorker",drawMe:function(){this.props.worker.tasks.length&&
this.props.drawWorkerDirections(this.props.worker._id)},render:function(){return React.DOM.li({key:this.props.worker._id},React.DOM.a({onClick:this.drawMe},this.props.worker.name))}});q=React.createClass({displayName:"RouterWorkers",drawWorkerDirections:function(a){this.props.workers.forEach(function(b){b._id===a&&b.drawDirections()?this.props.toggleRouterMode(b._id,b.tasks.map(function(a){if(a.schedule){var f=[{relevance:3,value:b.name},{descr:"Tipos",value:_.uniq(a.types).join(", ")},{descr:"Deslocamento",
value:g("%H:%M",a.directions.schedule.ini)+" < "+a.directions.duration.text+" - "+a.directions.distance.text+" > "+g("%H:%M",a.directions.schedule.end)},{descr:"Execu\u00e7\u00e3o",value:g("%H:%M",a.schedule.ini)+" < "+Math.floor(a.duration/1E3/60)+"min > "+g("%H:%M",a.schedule.end)},{descr:"Dura\u00e7\u00e3o",value:Math.floor(a.duration/1E3/60)+"min"}],x=_.map(a.tasks,"_id");a.schedule.from&&a.schedule.to&&(!_.isDate(a.schedule.from)&&(a.schedule.from=new Date(a.schedule.from)),!_.isDate(a.schedule.to)&&
(a.schedule.to=new Date(a.schedule.to)),f.push({descr:"Agenda",value:g("%d/%m/%Y",a.schedule.from)}),f.push({descr:"Turno",value:g("%H:%M",a.schedule.from)+" <> "+g("%H:%M",a.schedule.to)}));x.length&&f.push({descr:"ID",value:x.join(", ")});a.target&&f.push({descr:"Cliente",value:a.target.name,relevance:2});f.push({value:a.address.address});return{id:"wRTask-"+a.id,worker:b.name,location:a.location,attrs:f}}})):(b._id!==a&&b.cleanDirections(),b._id===a&&this.props.toggleRouterMode(null))}.bind(this))},
render:function(){return React.DOM.div({id:"RouterWorkers"},React.DOM.ul(null,this.props.workers.map(function(a){return r({drawWorkerDirections:this.drawWorkerDirections,key:a._id,worker:a})}.bind(this))))}});p=React.createClass({displayName:"RouterController",getInitialState:function(){return{messages:[],workers:[],day:this.props.router._day}},componentDidMount:function(){this.props.router.progress(function(a,b){if(this.isMounted())switch(a){case "message":this.state.messages.push(b),this.setState({messages:this.state.messages})}}.bind(this));
this.props.router.done(function(a){this.isMounted()&&this.setState({workers:a})}.bind(this));this.props.router.fail(function(){this.isMounted()&&this.props.cancelRoute()}.bind(this))},cancel:function(){this.state.workers.forEach(function(a){a.cleanDirections()});this.props.cancelRoute()},save:function(){this.state.workers.forEach(function(a){a.cleanDirections()});this.props.saveRoute(this.state.workers,this.state.day)},render:function(){return React.DOM.div({id:"Router",className:"leftMapControl"},
React.DOM.div({className:"controlIco"},React.DOM.i({className:"fi-page-multiple"})),React.DOM.div({className:"controlContent"},React.DOM.h4(null,"Roteador"),React.DOM.div({className:"panel contained clearfix"},!this.state.workers.length&&React.DOM.div({id:"RouterLog"},this.state.messages.map(function(a,b){return React.DOM.p({key:b},a)})),q({workers:this.state.workers,toggleRouterMode:this.props.toggleRouterMode}),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 columns text-right"},
React.DOM.button({onClick:this.cancel,className:"tiny alert button"},"Cancelar"),this.state.workers&&this.state.workers.length?React.DOM.button({onClick:this.save,className:"tiny success button"},"Salvar"):null)))))}});m=React.createClass({displayName:"ConsoleOpts",handleSubmit:function(a){a.preventDefault();a={day:this.refs.dayInput.getDOMNode().value,org:pager.org.id,locations:this.props.locations};h.navigate("/:org/console/:day/:locations",{namedParams:a})},render:function(){return React.DOM.div({id:"ConsoleOpts",
className:"leftMapControl"},React.DOM.div({className:"controlIco"},React.DOM.i({className:"fi-widget"})),React.DOM.div({className:"controlContent"},React.DOM.h4(null,"Op\u00e7\u00f5es da agenda"),React.DOM.div({className:"panel contained"},React.DOM.form({onSubmit:this.handleSubmit},React.DOM.div({className:"row"},React.DOM.div({className:"large-12 columns"},React.DOM.label(null,"Dia",y({ref:"dayInput",date:this.props.day,inputName:"day"})))),React.DOM.div({className:"row"},React.DOM.div({className:"large-12 columns text-right"},
React.DOM.button({className:"tiny success button"},"Ok")))))))}});n=React.createClass({displayName:"LeftPanel",componentDidMount:function(){$(this.getDOMNode()).on("click",".controlContent>h4,.controlIco",function(){$(this).closest(".leftMapControl").children(".controlContent,.controlIco").toggle();$("#Console").trigger("resize")})},render:function(){return React.DOM.nav({id:"LeftPanel"},React.DOM.div({id:"LeftPanelWrapper"},this.props.pending.length?z({items:this.props.pending,locations:this.props.locations}):
null,m({day:this.props.day,locations:this.props.locations}),this.props.router&&p({router:this.props.router,saveRoute:this.props.saveRoute,cancelRoute:this.props.cancelRoute,toggleRouterMode:this.props.toggleRouterMode}),A({routeTasks:this.props.routeTasks,locations:this.props.locations,day:this.props.day,setTaskFocus:this.props.setTaskFocus,selectedTask:this.props.selectedTask,hasGoogleMaps:this.props.hasGoogleMaps,queries:this.props.queries,setQueries:this.props.setQueries})))}});t=React.createClass({displayName:"RightPanelToolbar",
getInitialState:function(){return{CSVDataURI:null}},componentDidMount:function(){$(this.getDOMNode()).foundation();$(this.refs.cleanEmAll.getDOMNode()).on("click",this.props.emptySchedule)},exportToCSV:function(){function a(a){return(_.isDate(a)?a:new Date(a)).toLocaleString()}function b(a){_.isString(a)||(a=""+a);a=a.replace(/"/g,'""');return 0<=a.search(/("|,|\n)/g)?'"'+a+'"':a}var e,f,g;e="In\u00edcio estimado;Fim estimado;Encarregado;Tipo Ordem;Refer\u00eancia;Refer\u00eancia:::Tipo;Refer\u00eancia:::ID;Deslocamento;Endere\u00e7o".split(";").map(b).join(",")+
"\n";f=_.flatten(_.map(this.props.schedule,function(a){return _.map(a.tasks,function(b){return _.merge({worker:a.worker},b)})}));f.forEach(function(c,g){var d=[];d.push(a(c.schedule.ini));d.push(a(c.schedule.end));d.push(c.worker.name);d.push(_.uniq(c.work_orders.map(function(a){return a.type})).join(", "));c.target&&c.target.name?d.push(c.target.name):d.push("---");c.target&&c.target.type?d.push(c.target.type):d.push("---");c.target&&c.target.sys_id?d.push(c.target.sys_id):d.push("---");c.directions?
d.push(c.directions.distance.text+" | "+c.directions.duration.text):d.push("---");d.push(c.address.address);d=d.map(b).join(",");e+=g<f.length?d+"\n":d});g=new Blob([e],{type:"text/csv"});this.setState({CSVDataURI:URL.createObjectURL(g)})},cleanCSV:function(){this.setState({CSVDataURI:null})},render:function(){return React.DOM.div({id:"RightPanelToolbar"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 columns"},this.state.CSVDataURI?React.DOM.a({className:"button success small",
href:this.state.CSVDataURI,download:"Extra\u00e7\u00e3o-Pager-"+(new Date).toLocaleString()+".csv",onClick:this.cleanCSV},"Baixar"):React.DOM.button({className:"button secondary small",onClick:this.exportToCSV},"Exportar"),React.DOM.a({"data-dropdown":"RightPanelToolbarDropDown",className:"button secondary small dropdown"},"Op\u00e7\u00f5es"))),React.DOM.ul({id:"RightPanelToolbarDropDown","data-dropdown-content":!0,className:"f-dropdown"},React.DOM.li(null,React.DOM.a({ref:"cleanEmAll"},"Limpar"))))}});
s=React.createClass({displayName:"RightPanel",getInitialState:function(){return{contentVisible:!0}},componentDidMount:function(){var a=_.throttle(function(){if(!this.isMounted())return $(["#Console",window]).off("resize",a);var b=$(this.getDOMNode());b&&$("#Console").width()-$("#LeftPanel").width()!==b.width()&&this.forceUpdate()}.bind(this),100);$(["#Console",window]).on("resize",a)},toggleContent:function(){this.setState({contentVisible:!this.state.contentVisible})},cleanScheduleAndUpdate:function(){$.ajax({type:"DELETE",
url:pager.urls.ajax+"console/schedule/"+this.props.day}).done(function(){this.props.updateSchedule();this.props.syncQueries()}.bind(this))},render:function(){var a=pager.components.RouterCfg,b={},e=this.state.contentVisible&&(this.props.schedule.length||this.props.routerLoader);e&&(b.width=$("#Console").width()-$("#LeftPanel").width());return React.DOM.main({id:"RightPanel",style:b},e?React.DOM.div({id:"RightPanelContent"},this.props.routerLoader?React.DOM.div(null,React.DOM.h4(null,"Configura\u00e7\u00f5es de Roteamento"),
React.DOM.div({className:"panel"},a({day:this.props.routerLoader._day,onSet:this.props.routerLoader}))):null,this.props.schedule.length?C({schedule:this.props.schedule}):null,this.props.schedule.length?t({schedule:this.props.schedule,emptySchedule:this.cleanScheduleAndUpdate}):null):null,this.props.schedule.length||this.props.routerLoader?React.DOM.div({id:"ToggleRightPanel",className:React.addons.classSet({lonesome:!e})},React.DOM.i({onClick:this.toggleContent,className:"fi-arrows-expand"})):null)}});
k=React.createClass(_.merge({parseArgsToState:function(a){a=a||this.props;var b=a.args.day?a.args.day:(new Date).toYMD();a=(a=a.args.locations?a.args.locations:[])?_.isString(a)?a:_.isArray(a)?a.join(","):"":"";return{day:b,locations:a}},getInitialState:function(){var a,b=_.merge(this.parseArgsToState(),{mapState:pager.constant.console.map.AVAILABLE_TASKS,pending:[],queries:[],schedule:[]});if(Modernizr.localstorage){try{a=JSON.parse(localStorage.getItem("pager."+pager.org.id+".console.queries"))}catch(e){console.log(e)}b.queries=
a&&a.length?b.queries.concat(a):b.queries}return b},componentWillReceiveProps:function(a){var b=a.args.day!==this.state.day;this.setState(this.parseArgsToState(a),function(){if(b){for(var a=this.state.schedule;0<a.length;)a.pop();this.updateSchedule()}this.updateDefaultQuery(b)}.bind(this))},offCanvasMenuOpen:function(){$("#ScrollRoot").scrollTop(0).css("overflow-y","scroll");$("#appContainer").css("overflow-y","hidden")},offCanvasMenuClose:function(){$("#ScrollRoot, #appContainer").css("overflow-y",
"")},componentDidMount:function(){this.updateDefaultQuery(!0);this.putArgs();var a=_.throttle(function(){if(!this.isMounted)return $(window).off("resize",a);this.forceUpdate()}.bind(this),300);$(window).on("resize",a);this.updateSchedule(this.syncQueries);this.loadGoogleMaps();$(document).on("open.fndtn.offcanvas","[data-offcanvas]",this.offCanvasMenuOpen);$(document).on("close.fndtn.offcanvas","[data-offcanvas]",this.offCanvasMenuClose)},componentWillUnmount:function(){clearTimeout(this.updateSchedule.__timeout);
clearTimeout(this.syncQueries.__timeout);$(document).off("open.fndtn.offcanvas","[data-offcanvas]",this.offCanvasMenuOpen);$(document).off("close.fndtn.offcanvas","[data-offcanvas]",this.offCanvasMenuClose)},putArgs:function(){var a;a="/"+[pager.org.id,"console",this.state.day,this.state.locations].join("/");a!==h.getCurrentURI()&&h.navigate(a)},render:function(){var a=$(window).height()-$(".tab-bar").outerHeight();return React.DOM.div({id:"Console",style:{"min-height":a}},this.state.hasGoogleMaps?
B({queries:this.state.queries,setTaskFocus:this.setTaskFocus,routerWorker:this.state.routerWorker,mapState:this.state.mapState,height:a,setMapState:this.setMapState,selectedTask:this.state.selectedTask}):null,n({pending:this.state.pending,routeTasks:this.initRouter,queries:this.state.queries,toggleRouterMode:this.toggleRouterMode,saveRoute:this.saveRoute,cancelRoute:this.cancelRoute,day:this.state.day,router:this.state.router,locations:this.state.locations,hasGoogleMaps:this.state.hasGoogleMaps,setQueries:this.setQueries,
selectedTask:this.state.selectedTask,setTaskFocus:this.setTaskFocus}),s({router:this.state.router,updateSchedule:this.updateSchedule,syncQueries:this.syncQueries,schedule:this.state.schedule,day:this.state.day,totalWidth:$(window).width(),routerLoader:this.state.routerLoader,hasGoogleMaps:this.state.hasGoogleMaps}))}},k,D,E,F));_.merge(pager.components,{UserLink:l,ObjectLink:w,AttrTable:u});pager.console={};return k});
