define(["../ext/aviator/main","./console.queue","./console.tasks","./console.map","../helpers/utils.js"],function(h,r,s,t,u){function d(){this.data={};this.state={hasGoogleMaps:!1,mapState:"tasks"};this.rootComponent=null}var k,l,m,g,f,n,p,q;LazyLoad.css(["/css/console.css"]);f=React.createClass({displayName:"UserLink",render:function(){return this.props.user.url?React.DOM.a({target:"_blank",title:this.props.user.full_name,href:this.props.user.url},this.props.user.short_name):React.DOM.strong({title:this.props.user.full_name},
this.props.user.short_name)}});q=React.createClass({displayName:"ObjectLink",render:function(){return React.DOM.span(null,this.props.object.adj?" "+this.props.object.adj:null,React.DOM.span(null," "),this.props.object.url?React.DOM.a({target:"_blank",href:this.props.object.url},this.props.object.name):React.DOM.strong(null,this.props.object.name))}});p=React.createClass({displayName:"AttrItem",render:function(){var a=this.props.attr,b=React.addons.classSet({"main-attr":3===a.relevance,"important-attr":2===
a.relevance}),c=3===a.relevance&&_.isString(a.value)?a.value.toUpperCase():a.value,e=3!==a.relevance&&a.descr;return React.DOM.tr({className:b},e?React.DOM.td(null,a.descr):null,React.DOM.td({colSpan:3!==a.relevance&&e?1:2,title:!e&&a.descr?a.descr:""},a.url?React.DOM.a({href:a.url,target:"_blank"},c):c))}});n=React.createClass({displayName:"AttrTable",render:function(){var a=_.filter(this.props.attrs,{relevance:3}).concat(_.filter(this.props.attrs,{relevance:2})).concat(_.filter(this.props.attrs,
function(a){return!a.relevance||1>=a.relevance}));return React.DOM.table({className:"attr-table"},React.DOM.tbody(null,a.map(function(a,c){return p({key:c,attr:a})})))}});k=React.createClass({displayName:"LeftPanel",getInitialState:function(){return{visible:!0,lastUpdate:Date.now()}},render:function(){return React.DOM.nav({id:"LeftPanel"},React.DOM.div({id:"LeftPanelWrapper"},this.props.pending.length?r({items:this.props.pending,locations:this.props.locations}):null,s({routeTasks:this.props.routeTasks,
locations:this.props.locations,day:this.props.day,setTaskFocus:this.props.setTaskFocus,hasGoogleMaps:this.props.hasGoogleMaps,queries:this.props.queries,setQueries:this.props.setQueries})))}});l=React.createClass({displayName:"RightPanel",render:function(){return React.DOM.main({id:"RightPanel"})}});m=React.createClass({displayName:"Console",parseArgsToState:function(a){a=a||this.props;var b=a.args.day?a.args.day:(new Date).toYMD();a=(a=a.args.locations?a.args.locations:[])?_.isString(a)?a:_.isArray(a)?
a.join(","):"":"";return{day:b,locations:a}},getInitialState:function(){return this.parseArgsToState()},componentWillReceiveProps:function(a){var b=this.props.args.day!==this.state.day;this.setState(this.parseArgsToState(a),function(){this.updateDefaultQuery(b)}.bind(this))},componentDidMount:function(){this.updateDefaultQuery(!0);this.putArgs();g=_.throttle(function(){this.forceUpdate()}.bind(this),300);$(window).resize(g)},componentWillUnmount:function(){$(window).off("resize",g)},putArgs:function(){var a=
[pager.org.id,"console",this.state.day];this.state.locations.length&&a.push(this.state.locations);a="/"+a.join("/");a!==h.getCurrentURI()&&h.navigate(a)},updateDefaultQuery:function(a){this.props.lib.setDefaultQuery(this.state.day,a)},setQueries:function(a){this.props.lib.set("queries",a)},setTaskFocus:function(a){if(this.props.lib.state.selectedTask===a&&"task"===this.props.lib.state.mapState)return this.props.lib.state.mapState="tasks",this.props.lib.put();this.props.lib.state.mapState="task";this.props.lib.state.selectedTask=
a;this.props.lib.put()},setMapState:function(a){this.props.lib.state.mapState=a;this.props.lib.put()},prepareRoute:function(a){this.props.lib.router(this.state.day,a)},render:function(){var a={height:$(window).height()-$(".tab-bar").outerHeight()};return React.DOM.div({id:"Console",style:a},this.props.lib.state.hasGoogleMaps?t({queries:this.props.lib.data.queries,mapState:this.props.lib.state.mapState,setMapState:this.setMapState,selectedTask:this.props.lib.state.selectedTask}):null,k({pending:this.props.lib.data.pending,
routeTasks:this.prepareRoute,queries:this.props.lib.data.queries,day:this.state.day,locations:this.state.locations,hasGoogleMaps:this.props.lib.state.hasGoogleMaps,setQueries:this.setQueries,setTaskFocus:this.setTaskFocus}),l({workers:this.props.lib.data.workers,hasGoogleMaps:this.props.lib.state.hasGoogleMaps}))}});d.prototype.put=function(){Modernizr.localstorage&&(localStorage.setItem("pager."+pager.org.id+".console.queries",JSON.stringify(this.data.queries.filter(function(a){return"Agenda"!==
a.name}).map(function(a){a=_.cloneDeep(a);a.tasks=[];return a}))),localStorage.setItem("pager."+pager.org.id+".console.workers",JSON.stringify(this.data.workers)));this.rootComponent.setProps({lib:this})};d.prototype.router=function(a,b){var c=this;require(["../lib/router"],function(e){(new e(a,b,c.data.workers)).init()})};d.prototype.set=function(a,b){"queries"===a&&(b=b.filter(function(a,b){return"Agenda"===a.name||a.tasks&&a.tasks.length}).map(function(a){a.id=a.id||"query-"+Math.random().toString();
return a}));this.data[a]=b;this.put()};d.prototype.loadMaps=function(){console.log("loading google maps...");var a=this,b=Math.random().toString(36).substr(2),c=function(){_.delay(function(){console.log("done loading google maps");window["Pager_"+b]&&delete window["Pager_"+b];a.state.hasGoogleMaps=!0;a.put()},500)};if("undefined"!==typeof google&&google.maps)return setTimeout(c,500);u.loadAPIKeys(function(a){window["Pager_"+b]=c;LazyLoad.js(["https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&key="+
a.google+"&libraries=geometry&callback=Pager_"+b])}.bind(this))};d.prototype.setDefaultQuery=function(a,b){var c={id:"query-"+Math.random().toString(36).substr(2),name:"Agenda",tasks:[],query:{schedule:[a]}},e=_.findIndex(this.data.queries,{name:"Agenda"});if(0<=e){if(this.data.queries[e].query.schedule[0]===c.query.schedule[0])return;this.data.queries[e]=c}else{if(!b)return;this.data.queries.unshift(c)}console.log("update day",a);this.put();this.fetchQueries()};d.prototype.fetchQueries=function(){this.data.queries.forEach(function(a,
b){$.get("/"+pager.org.id+"/api/console/tasks",a.query).done(function(b){_.isArray(b)&&(a.tasks=b,this.put())}.bind(this))}.bind(this))};d.prototype.fetchWorkers=function(){$.get("/"+pager.org.id+"/api/console/workers").done(function(a){this.set("workers",a)}.bind(this))};d.prototype.fetchPendingOrders=function(){$.get("/json/console.pending.json").done(function(a){if(_.isString(a))try{a=JSON.parse(a)}catch(b){console.log(b),a=[]}this.data.pending=a;this.put()}.bind(this))};d.prototype.init=function(a,
b){var c;this.data={pending:[],queries:[],workers:[]};if(Modernizr.localstorage){try{c=JSON.parse(localStorage.getItem("pager."+pager.org.id+".console.queries"))}catch(e){console.log(e)}this.data.queries=c&&c.length?this.data.queries.concat(c):this.data.queries;try{this.data.workers=JSON.parse(localStorage.getItem("pager."+pager.org.id+".console.workers"))}catch(d){console.log(d)}}this.fetchQueries();this.fetchWorkers();this.rootComponent=a;b(this);this.fetchPendingOrders();this.loadMaps()};_.merge(pager.components,
{UserLink:f,ObjectLink:q,AttrTable:n});f=new d;pager.console=f;return{component:m,librarian:f}});
