define(function(){return{updateDefaultQuery:function(b){var a=this.state.queries,c={id:"query-"+Math.random().toString(36).substr(2),name:"Agenda",tasks:[],query:{schedule:[this.state.day]}},d=_.findIndex(a,{name:"Agenda"});if(0<=d){if(a[d].query.schedule[0]===c.query.schedule[0])return;a[d]=c}else{if(!b)return;a.unshift(c)}this.setState({queries:a},this.syncQueries)},setQueries:function(b){b=b.filter(function(a,b){return"Agenda"===a.name||a.tasks}).map(function(a){a.id=a.id||"query-"+Math.random().toString(36).substr(2);
return a});Modernizr.localstorage&&localStorage.setItem("pager."+pager.org.id+".console.queries",JSON.stringify(this.state.queries.filter(function(a){return"Agenda"!==a.name}).map(function(a){a=_.clone(a);a.tasks=[];return a})));this.setState({queries:b})},fetchQuery:function(b){return $.get(pager.urls.ajax+"console/tasks/"+this.state.day,b.query).done(function(a){if(_.isArray(a)){var c=this.state.queries,d=_.find(c,{id:b.id})||_.find(c,{name:b.name});d&&(d.tasks=a,this.setState({queries:c}))}}.bind(this))},
fetchQueries:function(b){var a=[],c;this.state.queries.forEach(function(b){a.push(this.fetchQuery(b))}.bind(this));c=$.when.apply($,a);_.isFunction(b)&&c.always(b)},syncQueries:function(){clearTimeout(this.syncQueries.__timeout);this.isMounted()&&this.fetchQueries(function(){this.syncQueries.__timeout=setTimeout(this.syncQueries,pager.constant.console.QUERY_UPDATE_INTERVAL)}.bind(this))}}});
