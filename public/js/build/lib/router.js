define(["../ext/strftime"],function(e){function r(e,t,n){var r=!1;this.id=Math.random().toString(36).substr(2),this.deferred=$.Deferred(),$.when($.get(pager.build.moduleRoot+"/lib/router.worker.js"),$.get(pager.build.moduleRoot+"/ext/crypto.sha1.js")).done(function(r,i){r=r[0],i=i[0];var s=new Blob([$("#script_lodash").text(),i,r],{type:"application/javascript"}),o=window.URL.createObjectURL(s);this.webWorker=new Worker(o),window.URL.revokeObjectURL(o),this.connectToWorker(),this.webWorker.postMessage({cmd:"startRouter",data:{tasks:t,workers:n,day:e}})}.bind(this));var i=this.deferred.promise();return this.stopRouter=function(){console.groupEnd(),console.log("Stopping Router..."),r=!0},i.stopRouter=this.stopRouter,this.amIDead=function(){return r},i}var t,n;return r.prototype.fetchTypes=function(e){$.get(pager.urls.ajax+"console/typeDuration",{types:e}).done(function(e){this.webWorker.postMessage({cmd:"parseTypes",data:e})}.bind(this))},r.prototype.workerRouteOptimizer=function(e,t){function i(){if(r.amIDead())return;var i,s,o,u,a,f,l=0,c;if(e.tasks.length){i=n.getGDirections(),s=n.getOrder(),o=e.tasks.concat(),u=!!e.startPoint,a=!!e.endPoint||e.endPoint!==null,e.tasks=[];for(var h=u?1:0;h<(a?s.length-1:s.length);h++){c=o[s[h]-(u?1:0)],(f=i.routes[0])&&(f=f.legs[e.tasks.length]);if(!f)continue;c.directions={origin:{lat:f.start_location.lat(),lng:f.start_location.lng()},distance:f.distance,duration:f.duration,schedule:{ini:new Date,end:new Date}},c.directions.schedule.ini.setTime(e.workShift.from.getTime()+l),l+=f.duration.value*1e3,c.directions.schedule.end.setTime(e.workShift.from.getTime()+l),c.schedule=c.schedule||{},c.schedule.ini=new Date,c.schedule.end=new Date,c.schedule.ini.setTime(e.workShift.from.getTime()+l),l+=c.duration,c.schedule.end.setTime(e.workShift.from.getTime()+l),e.tasks.push(c)}o=null,e.drawDirections=function(){return e.directions?(e.directions.setMap(null),delete e.directions,!1):(e.directions=new google.maps.DirectionsRenderer({directions:i,map:pager.console.map,polylineOptions:{strokeColor:e.color},suppressMarkers:!0}),!0)},e.cleanDirections=function(){e.directions&&(e.directions.setMap(null),delete e.directions)}}console.groupEnd(),r.deferred.notify("message","Calculada rota de "+e.name),t()}var r=this;if(this.amIDead())return;console.group(e.name),e.tasks.length?(n.startOver(),n.setTravelMode(google.maps.DirectionsTravelMode.DRIVING),n.addWaypoint(new google.maps.LatLng(e.startPoint.lat,e.startPoint.lng),function(){console.log("startPoint",e.startPoint)}),_.forEach(e.tasks,function(e){n.addWaypoint(new google.maps.LatLng(e.location.lat,e.location.lng),function(){console.log("new waypoint",e.address.address)})}),e.endPoint&&n.addWaypoint(new google.maps.LatLng(e.endPoint.lat,e.endPoint.lng),function(){console.log("endPoint",e.endPoint)}),e.endPoint||e.endPoint===null?n.solveAtoZ(i):n.solveRoundTrip(i)):i()},r.prototype.startTSP=function(e){if(this.amIDead())return;this.deferred.notify("Iniciando Otimizador de Direções...");var r=this,i=["../ext/async"];t||i.push("../ext/BpTspSolver"),require.ensure(i,function(i){var s=i("../ext/async");t=t||i("../ext/BpTspSolver"),n=n||new t(pager.console.map,null,function(){alert("Ops... Ocorreu um erro e o Roteamento foi abortado."),console.log(arguments),r.stopRouter(),r.deferred.reject()}),s.eachSeries(e,r.workerRouteOptimizer.bind(r),function(t){if(t)throw t;r.deferred.notify("message","Finalizado cálculo de rotas"),r.deferred.resolve(e)})})},r.prototype.connectToWorker=function(){this.webWorker.addEventListener("message",function(e){if(this.amIDead())return;switch(e.data.type){case"progressLog":console.log(e.data.data);break;case"logMessage":this.deferred.notify("message",e.data.data);break;case"assertion":pager.isDev&&console.assert(e.data.data[0],e.data.data[1]||"Assertion failed");break;case"fetchTypes":this.fetchTypes(e.data.data);break;case"endOfTheLine":this.startTSP(e.data.data)}}.bind(this))},r});