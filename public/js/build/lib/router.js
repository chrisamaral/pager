define(["../ext/strftime"],function(q){function c(a,b,d){var e=!1;this.id=Math.random().toString(36).substr(2);this.deferred=$.Deferred();$.when($.get(pager.build.moduleRoot+"/lib/router.worker.js"),$.get(pager.build.moduleRoot+"/ext/crypto.sha1.js")).done(function(g,e){g=g[0];e=e[0];var l=new Blob([$("#script_lodash").text(),e,g],{type:"application/javascript"}),l=window.URL.createObjectURL(l);this.webWorker=new Worker(l);window.URL.revokeObjectURL(l);this.connectToWorker();this.webWorker.postMessage({cmd:"startRouter",
data:{tasks:b,workers:d,day:a}})}.bind(this));var g=this.deferred.promise();this.stopRouter=function(){console.groupEnd();console.log("Stopping Router...");e=!0};g.stopRouter=this.stopRouter;this.amIDead=function(){return e};return g}var m,b;c.prototype.fetchTypes=function(a){$.get(pager.urls.ajax+"console/typeDuration",{types:a}).done(function(a){this.webWorker.postMessage({cmd:"parseTypes",data:a})}.bind(this))};c.prototype.workerRouteOptimizer=function(a,p){function d(){if(!e.amIDead()){var g=
b.getGDirections(),d=b.getOrder();b.getDurations();var c=a.tasks.concat(),l=!!a.startPoint,m=!(!a.endPoint&&null===a.endPoint),h,k=0,f;a.tasks=[];for(var n=l?1:0;n<(m?d.length-1:d.length);n++)f=c[d[n]-(l?1:0)],(h=g.routes[0])&&(h=h.legs[a.tasks.length]),h&&(f.directions={origin:{lat:h.start_location.lat(),lng:h.start_location.lng()},distance:h.distance,duration:h.duration,schedule:{ini:new Date,end:new Date}},f.directions.schedule.ini.setTime(a.workShift.from.getTime()+k),k+=1E3*h.duration.value,
f.directions.schedule.end.setTime(a.workShift.from.getTime()+k),f.schedule=f.schedule||{},f.schedule.ini=new Date,f.schedule.end=new Date,f.schedule.ini.setTime(a.workShift.from.getTime()+k),k+=f.duration,f.schedule.end.setTime(a.workShift.from.getTime()+k),a.tasks.push(f));c=null;console.groupEnd();a.drawDirections=function(){if(a.directions)return a.directions.setMap(null),delete a.directions,!1;a.directions=new google.maps.DirectionsRenderer({directions:g,map:pager.console.map,polylineOptions:{strokeColor:a.color},
suppressMarkers:!0});return!0};a.cleanDirections=function(){a.directions&&(a.directions.setMap(null),delete a.directions)};e.deferred.notify("message","Calculada rota de "+a.name);p()}}if(!this.amIDead()){var e=this;b.startOver();b.setTravelMode(google.maps.DirectionsTravelMode.DRIVING);console.group(a.name);b.addWaypoint(new google.maps.LatLng(a.startPoint.lat,a.startPoint.lng),function(){console.log("startPoint",a.startPoint)});_.forEach(a.tasks,function(a){b.addWaypoint(new google.maps.LatLng(a.location.lat,
a.location.lng),function(){console.log("new waypoint",a.address.address)})});a.endPoint&&b.addWaypoint(new google.maps.LatLng(a.endPoint.lat,a.endPoint.lng),function(){console.log("endPoint",a.endPoint)});a.endPoint||null===a.endPoint?b.solveAtoZ(d):b.solveRoundTrip(d)}};c.prototype.startTSP=function(a){if(!this.amIDead()){this.deferred.notify("Iniciando Otimizador de Dire\u00e7\u00f5es...");var c=this,d=["../ext/async"];m||d.push("../ext/BpTspSolver");require.ensure(d,function(e){var d=e("../ext/async");
m=m||e("../ext/BpTspSolver");b=b||new m(pager.console.map,null,function(){alert("Ops... Ocorreu um erro e o Roteamento foi abortado.");console.log(arguments);c.stopRouter();c.deferred.reject()});d.eachSeries(a,c.workerRouteOptimizer.bind(c),function(b){if(b)throw b;c.deferred.notify("message","Finalizado c\u00e1lculo de rotas");c.deferred.resolve(a)})})}};c.prototype.connectToWorker=function(){this.webWorker.addEventListener("message",function(a){if(!this.amIDead())switch(a.data.type){case "progressLog":console.log(a.data.data);
break;case "logMessage":this.deferred.notify("message",a.data.data);break;case "assertion":pager.isDev&&console.assert(a.data.data[0],a.data.data[1]||"Assertion failed");break;case "fetchTypes":this.fetchTypes(a.data.data);break;case "endOfTheLine":this.startTSP(a.data.data)}}.bind(this))};return c});
