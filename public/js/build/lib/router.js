define(["../ext/strftime"],function(q){function b(a,e,n){this.id=Math.random().toString(36).substr(2);this.deferred=$.Deferred();$.when($.get(pager.build.moduleRoot+"/lib/router.worker.js").pipe(function(a){return a}),$.get(pager.build.moduleRoot+"/ext/crypto.sha1.min.js").pipe(function(a){return a})).done(function(f,b){var d=new Blob([$("#script_lodash").text(),b,f],{type:"application/javascript"}),d=window.URL.createObjectURL(d);this.webWorker=new Worker(d);window.URL.revokeObjectURL(d);this.connectToWorker();
this.webWorker.postMessage({cmd:"startRouter",data:{tasks:e,workers:n,day:a}})}.bind(this));return this.deferred.promise()}b.prototype.fetchTypes=function(a){$.get(pager.urls.ajax+"console/typeDuration",{types:a}).done(function(a){this.webWorker.postMessage({cmd:"parseTypes",data:a})}.bind(this))};b.prototype.drawGraph=function(a){console.log(a);var e=a.lines;a=a.polygons;this.lines=this.lines||[];this.polygons=this.polygons||[];_.forEach(this.lines.concat(this.polygons),function(a){a.setMap(null)});
this.lines=[];this.polygons=[];_.forEach(e,function(a){10<a.points.length&&console.log(a.points);this.lines.push(new google.maps.Polyline({map:pager.console.map,strokeColor:a.color,path:_.map(a.points,function(a){return new google.maps.LatLng(a.lat,a.lng)})}))},this);_.forEach(a,function(a){this.polygons.push(new google.maps.Polygon({map:pager.console.map,fillColor:a.color,strokeWeight:0,path:_.map(a.points,function(a){return new google.maps.LatLng(a.lat,a.lng)})}))},this)};b.prototype.startTSP=function(a){var e=
this,b=!0;require(["../ext/async","../ext/BpTspSolver"],function(f,k){var d,c;d=$('<div class="reveal-modal" data-reveal>').append("<h2>Painel do Roteador</h2>").attr("id","R-"+e.id).appendTo("body");d.foundation("reveal");c=new k(pager.console.map,d[0]);f.eachSeries(a,function(a,d){function f(){var p=c.getGDirections(),g=c.getOrder(),h=a.tasks.concat(),m=!!a.startingPoint,k=!(!a.endPoint&&null===a.endPoint);a.tasks=[];for(var l=m?1:0;l<(k?g.length-1:g.length);l++)a.tasks.push(h[g[l]-(m?1:0)]);h=
null;h=c.getDurations();console.log(g,h);console.groupEnd();a.drawDirections=function(){b&&(e.polygons.concat(e.lines).forEach(function(a){a.setMap(null)}),b=!1);a.directions&&a.directions.setMap(null);a.directions=new google.maps.DirectionsRenderer({directions:p,map:pager.console.map,polylineOptions:{strokeColor:a.color}})};a.cleanDirections=function(){a.directions&&a.directions.setMap(null);e.polygons.concat(e.lines).forEach(function(a){a.setMap(pager.console.map)});b=!0};d()}c.startOver();c.setTravelMode(google.maps.DirectionsTravelMode.DRIVING);
console.group(a.name);c.addWaypoint(new google.maps.LatLng(a.startingPoint.lat,a.startingPoint.lng),function(){console.log("startingPoint",a.startingPoint)});_.forEach(a.tasks,function(a){c.addWaypoint(new google.maps.LatLng(a.location.lat,a.location.lng),function(){console.log("new waypoint",a.address.address)})});a.endPoint&&c.addWaypoint(new google.maps.LatLng(a.endPoint.lat,a.endPoint.lng),function(){console.log("endPoint",a.endPoint)});a.endPoint||null===a.endPoint?c.solveAtoZ(f):c.solveRoundTrip(f)},
function(b){if(b)throw b;console.log(a)})})};b.prototype.connectToWorker=function(){this.webWorker.addEventListener("message",function(a){switch(a.data.type){case "progressLog":console.log(a.data.data);break;case "assertion":pager.isDev&&console.assert(a.data.data[0],a.data.data[1]||"Assertion failed");break;case "fetchTypes":this.fetchTypes(a.data.data);break;case "drawGraph":this.drawGraph(a.data.data);break;case "endOfTheLine":this.startTSP(a.data.data)}}.bind(this))};return b});
