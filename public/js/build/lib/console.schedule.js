/** @jsx React.DOM */define(["../ext/strftime"],function(e){var t,n,r,i;i=React.createClass({displayName:"ScheduleTask",render:function(){var e,t,n;return e=(this.props.task.duration+this.props.task.directions.duration.value*1e3)*this.props.microSecondWidth,t=new Date(this.props.task.directions.schedule.ini),n=(t.getTime()-this.props.timelineBoundaries.ini.getTime())*this.props.microSecondWidth,n+=this.props.index*3,React.DOM.div({className:"scheduleTask",style:{width:e+"px",left:n+"px"},"data-dropdown":this.props.dropdown})}});var s=React.createClass({displayName:"ScheduleInfo",render:function(){var t=pager.components.AttrTable;return React.DOM.div({id:this.props._id,className:"f-dropdown medium content","data-dropdown-content":!0},React.DOM.table({className:"dropdown-table"},React.DOM.tbody(null,React.DOM.tr(null,React.DOM.td({colSpan:2},React.DOM.strong(null,this.props.task.address.address))),React.DOM.tr(null,React.DOM.td(null,React.DOM.i({className:"f-ico fi-clock"}),React.DOM.strong(null,"Deslocamento")),React.DOM.td(null,e("%H:%M",new Date(this.props.task.directions.schedule.ini))+"   <>   "+e("%H:%M",new Date(this.props.task.directions.schedule.end)))),React.DOM.tr(null,React.DOM.td(null,React.DOM.i({className:"f-ico fi-map"}),React.DOM.strong(null,"Deslocamento")),React.DOM.td(null,this.props.task.directions.distance.text+"   •   "+this.props.task.directions.duration.text)),React.DOM.tr(null,React.DOM.td(null,React.DOM.i({className:"f-ico fi-clock"}),React.DOM.strong(null,"Execução")),React.DOM.td(null,e("%H:%M",new Date(this.props.task.schedule.ini))+"   <>   "+e("%H:%M",new Date(this.props.task.schedule.end)))))),this.props.task.work_orders.map(function(e){return t({key:e._id,attrs:e.attrs})}))}});r=React.createClass({displayName:"ScheduleTimeLine",getInitialState:function(){return{id:Math.random().toString(36).substr(2)}},componentDidMount:function(){this.updateDropDown()},removeDropDown:function(){this.props.tasks.forEach(function(e,t){$("#info"+this.props._id+e.addressPlusTargetIDSHA1).remove()}.bind(this))},componentDidUpdate:function(){this.updateDropDown()},updateDropDown:function(){this.props.tasks.forEach(function(e,t){var n="info"+this.props._id+e.addressPlusTargetIDSHA1,r=$(React.renderComponentToStaticMarkup(s({_id:n,task:e}))),i=$("#"+n);i.length?i.html(r.html()):r.appendTo("body")}.bind(this))},componentWillUnmount:function(){this.removeDropDown()},render:function(){return React.DOM.div({className:"panel scheduleTimeLine"},React.DOM.div(null,this.props.tasks.map(function(e,t){return i({key:"t-"+e.addressPlusTargetIDSHA1,task:e,index:t,dropdown:"info"+this.props._id+e.addressPlusTargetIDSHA1,microSecondWidth:this.props.microSecondWidth,timelineBoundaries:this.props.timelineBoundaries})}.bind(this))))}});var o=React.createClass({displayName:"ScheduleRowMenu",render:function(){return React.DOM.ul({id:this.props._id,className:"f-dropdown","data-dropdown-content":!0},React.DOM.li(null,React.DOM.a({"data-doempty":!0},"Limpar")),React.DOM.li(null,React.DOM.a({"data-doremove":!0},"Remover")))}});n=React.createClass({displayName:"ScheduleRow",emptySchedule:function(){$.ajax({type:"DELETE",url:pager.urls.ajax+"console/schedule/"+this.props.schedule._id+"/tasks"}).done(this.props.updateSchedule)},removeSchedule:function(){$.ajax({type:"DELETE",url:pager.urls.ajax+"console/schedule/"+this.props.schedule._id}).done(this.props.updateSchedule)},componentWillUnmount:function(){$("#Menu"+this.props.schedule._id).remove()},componentDidMount:function(){var e="Menu"+this.props.schedule._id,t,n=$(e);if(n.length)return;t=$(React.renderComponentToStaticMarkup(o({_id:e}))).appendTo("body"),t.find("[data-doempty]").click(this.emptySchedule),t.find("[data-doremove]").click(this.removeSchedule),$(this.getDOMNode()).foundation()},render:function(){return React.DOM.div({className:"scheduleRow"},React.DOM.div({className:"scheduleLabels"},React.DOM.span({className:"success label"},this.props.schedule.worker.name),React.DOM.a({className:"secondary label fi-widget",title:"Menu","data-dropdown":"Menu"+this.props.schedule._id})),r({tasks:this.props.schedule.tasks,_id:this.props.schedule.worker._id,microSecondWidth:this.props.microSecondWidth,timelineBoundaries:this.props.timelineBoundaries}))}});var u=React.createClass({displayName:"ScheduleHeader",render:function(){var t=100,n=t/this.props.microSecondWidth,r=this.props.timelineBoundaries.ini.getTime(),i=_.range(r,this.props.timelineBoundaries.end.getTime(),n);return React.DOM.div({id:"ScheduleHeader"},i.map(function(n,r){var i=e("%H:%M",new Date(n));return React.DOM.span({className:"scheduleHeaderTick",style:{left:r*t},key:i},i)}.bind(this)))}});return t=React.createClass({displayName:"ScheduleView",getInitialState:function(){return{microSecondWidth:null}},calcDimensions:function(e){if(!this.isMounted())return;e=e||this.props;var t=$(this.refs.container.getDOMNode()).width(),n={ini:Infinity,end:-Infinity},r=-Infinity,i;_.forEach(e.schedule,function(e){r=Math.max(e.tasks.length,r),_.forEach(e.tasks,function(e){var t=new Date(e.directions.schedule.ini),r=new Date(e.schedule.end);t<n.ini&&(n.ini=t),r>n.end&&(n.end=r)})}),n.ini===Infinity&&(n.ini=new Date(this.props.day),n.ini.setHours(8)),n.end===-Infinity&&(n.end=new Date(this.props.day),n.end.setHours(16)),i=(t-5*r)/(n.end.getTime()-n.ini.getTime()),this.setState({microSecondWidth:i,timelineBoundaries:n})},componentWillReceiveProps:function(e){this.calcDimensions(e)},componentDidMount:function(){this.calcDimensions()},syncSchedules:function(){this.props.updateSchedule(),this.props.syncQueries()},render:function(){return React.DOM.div({id:"Schedule"},React.DOM.div({id:"ScheduleContainer",ref:"container"},this.state.microSecondWidth!==null?u({microSecondWidth:this.state.microSecondWidth,timelineBoundaries:this.state.timelineBoundaries}):null,this.state.microSecondWidth!==null?this.props.schedule.map(function(e){return n({key:e._id,updateSchedule:this.syncSchedules,schedule:e,microSecondWidth:this.state.microSecondWidth,timelineBoundaries:this.state.timelineBoundaries})}.bind(this)):React.DOM.p(null,"...")))}}),t});