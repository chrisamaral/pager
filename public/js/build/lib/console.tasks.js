define(["../helpers/utils","./component.DateInput"],function(t,r){function s(a){var b=[];a.forEach(function(a){if(a.location){var c=_.find(b,function(b){return b.ref!==a.ref?!1:(b.target?b.target.sys_id:null)===(a.target?a.target.sys_id:null)&&b.address.address.toLowerCase()===a.address.address.toLowerCase()}),g=function(b){return b.sys_id===a.sys_id||b.id===a.id};c?_.any(c.tasks,g)||(c.tasks.push(a),c.types.push(a.type),a.schedule&&(c.schedule=c.schedule||a.schedule,c.schedule.from=c.schedule.from<
a.schedule.from?c.schedule.from:a.schedule.from,c.schedule.to=c.schedule.to<a.schedule.to?c.schedule.to:a.schedule.to)):(c={ref:a.ref,address:a.address,target:a.target,types:[a.type],tasks:[a]},a.schedule&&(c.schedule=a.schedule),a.location&&(c.location=a.location),b.push(c))}});return b}var e,f,h,k,l,m,n,p,q={schedule:"Agenda::Ordem",task_id:"C\u00f3digo::Ordem",creation:"Ingresso::Ordem",task_status:"Status::Ordem",task_type:"Tipo::Ordem",customer_id:"C\u00f3digo::Cliente",customer_name:"Nome::Cliente",
address:"Endere\u00e7o::Cliente"};k=React.createClass({displayName:"TxtInput",render:function(){return React.DOM.input({name:this.props.inputName,required:!0,autoComplete:"on",type:"text",defaultValue:"",placeholder:this.props.name})}});h=React.createClass({displayName:"FilterItem",killFilter:function(a){a.preventDefault();this.props.removeFilter(this.props.index)},render:function(){var a;switch(this.props.id){case "schedule":case "creation":a=r;break;default:a=k}return React.DOM.div({className:"row"},
React.DOM.div({className:"large-12 columns text-right"},React.DOM.label(null,React.DOM.strong(null,this.props.name,React.DOM.a({onClick:this.killFilter}," - ")),a({id:this.props.id,name:this.props.name,inputName:this.props.id}))))}});f=React.createClass({displayName:"FilterList",handleSubmit:function(a){a.preventDefault();a=$(a.currentTarget).serializeArray();var b={};_.forEach(a,function(a){!a||_.isString(a.value)&&!a.value.length||(b[a.name]=b[a.name]||[],b[a.name].push(a.value))});$.get("/"+pager.org.id+
"/api/console/tasks",b).done(function(a){_.isArray(a)&&this.props.pushQuery(b,a)}.bind(this))},render:function(){var a=this.props.filters.map(function(a,d){Foundation.utils.random_str(10);return h({key:a.key,index:d,id:a.id,name:a.name,removeFilter:this.props.removeFilter})}.bind(this));return React.DOM.div({className:"filter-list panel"},React.DOM.form({onSubmit:this.handleSubmit},a,React.DOM.div({className:"row"},React.DOM.div({className:"large-12 columns text-right"},React.DOM.button({type:"submit",
className:"tiny success button"},"Buscar")))))}});m=React.createClass({displayName:"QueryInfoDropDown",render:function(){return React.DOM.div({"data-dropdown-content":!0,className:"f-dropdown content medium hide",id:this.props.id},React.DOM.h4({className:"subheader"},(this.props.count||"Nenhuma")+(1<this.props.count?" ordens":" ordem")),React.DOM.table({className:"queryInfoDropDownTable"},React.DOM.tbody(null,_.map(this.props.query,function(a,b){return React.DOM.tr({key:b},React.DOM.td(null,q[b]),
React.DOM.td(null,a.map(function(a,b){return React.DOM.span({key:b,className:"round secondary label"},a)})))}))))}});n=React.createClass({displayName:"QueryTask",getInitialState:function(){return{id:"Q"+Math.random().toString(36).substr(2),hasLocation:!1}},renderDropdown:function(a){a=a||this.props;$("#"+this.state.id+"Menu").remove();var b=$(React.renderComponentToString(React.DOM.ul({id:this.state.id+"Menu",className:"tiny f-dropdown hide","data-dropdown-content":!0},a.task.location?React.DOM.li(null,
React.DOM.a({id:this.state.id+"focusOnMe"},"Focar")):null,React.DOM.li(null,React.DOM.a({id:this.state.id+"killMe"},"Descartar"))))).appendTo("body");$("#"+this.state.id+"focusOnMe").click(this.mapFocusOnMe);$("#"+this.state.id+"killMe").click(this.killMe);this.state.hasLocation!==!!a.task.location&&this.setState({hasLocation:!!a.task.location});b.foundation()},componentDidMount:function(){this.renderDropdown()},componentWillReceiveProps:function(a){a.task.location&&!this.state.hasLocation&&this.renderDropdown(a)},
componentWillUnmount:function(){$("#"+this.state.id+"Menu").remove()},killMe:function(){this.props.removeTask(this.props.index);$("#"+this.state.id+"Menu").remove()},mapFocusOnMe:function(){this.props.setTaskFocus(this.props.task.id)},render:function(){var a=pager.components.AttrTable;return React.DOM.div({className:"queryTask"},React.DOM.a({className:"radius ico fi-list",title:"Menu","data-dropdown":this.state.id+"Menu"}),a({attrs:this.props.task.attrs}))}});p=React.createClass({displayName:"LookupProgress",
getInitialState:function(){return{lookupProgress:null,alreadyStartedLookup:!1}},startGeoLookup:function(){this.state.alreadyStartedLookup||(this.setState({alreadyStartedLookup:!0}),require(["../lib/task.geocoder"],function(a){var b=new a(this.props.tasks);b.onProgress=function(a,c,g,e){if(!this.isMounted())return b.abort();try{this.setState({lookupProgress:c?Math.floor(100*a/c):null},function(){"noRedraw"!==e&&this.props.updateTask(g)}.bind(this))}catch(f){throw b.abort(),f;}}.bind(this);b.onComplete=
function(){setTimeout(function(){this.setState({lookupProgress:null})}.bind(this),2E3)}.bind(this);b.init()}.bind(this)))},componentWillReceiveProps:function(a){a.hasGoogleMaps&&this.startGeoLookup()},componentDidMount:function(){this.props.hasGoogleMaps&&this.startGeoLookup()},render:function(){var a={};null===this.state.lookupProgress&&(a.display="none");return React.DOM.progress({style:a,value:this.state.lookupProgress,max:100,title:this.state.lookupProgress+"% das ordens foram localizadas"})}});
l=React.createClass({displayName:"QueryElem",getInitialState:function(){return{taskLength:this.props.query.tasks.length,visibleTasks:!0,triggedMenu:!1,auxId:"q"+Math.random().toString(36).substr(2)}},killMe:function(a){a.preventDefault();this.props.popQuery(this.props.index)},routeMe:function(a){a.preventDefault();this.props.routeThem(this.props.query.tasks)},cleanDropdown:function(){$("#"+this.state.auxId+"Menu").remove();$("#"+this.state.auxId+"Info").remove()},renderDropdown:function(){this.cleanDropdown();
var a=$(React.renderComponentToString(React.DOM.ul({id:this.state.auxId+"Menu",className:"tiny f-dropdown hide","data-dropdown-content":!0},React.DOM.li(null,React.DOM.a({id:this.state.auxId+"routeMe"},"Rotear")),React.DOM.li(null,React.DOM.a({id:this.state.auxId+"killMe"},"Descartar"))))).appendTo("body"),b=$(React.renderComponentToString(m({id:this.state.auxId+"Info",count:this.props.query.tasks.length,query:this.props.query.query}))).appendTo("body");$("#"+this.state.auxId+"killMe").click(this.killMe);
$("#"+this.state.auxId+"routeMe").click(this.routeMe);$([this.getDOMNode(),a[0],b[0]]).foundation()},componentDidMount:function(){this.renderDropdown()},componentWillUnmount:function(){this.cleanDropdown()},componentDidUpdate:function(){this.props.query.tasks.length!==this.state.taskLength&&(this.renderDropdown(),this.setState({taskLength:this.props.query.tasks.length}))},removeTask:function(a){var b=this.props.query.tasks;b.splice(a,1);this.setTasks(b)},updateTask:_.debounce(function(a){var b=this.props.query.tasks,
d=_.findIndex(b,{id:a.id});0>d||(b[d]=a,this.setTasks(b))},300),setTasks:function(a){var b=this.props.query;b.tasks=a;this.props.setQuery(b,this.props.index)},toggleTasks:function(a){a.preventDefault();this.setState({visibleTasks:!this.state.visibleTasks})},render:function(){var a=React.addons.classSet({"no-flow-x":!0,hide:!this.state.visibleTasks}),b=function(a){a.stopPropagation()};return React.DOM.div({className:"panel sequential queryResult"},React.DOM.h5({className:"clearfix",onClick:this.toggleTasks},
this.props.query.name?this.props.query.name:null,React.DOM.a({onClick:b,className:"right radius ico fi-info",title:"Informa\u00e7\u00e3o","data-dropdown":this.state.auxId+"Info"}),React.DOM.a({onClick:b,className:"right radius ico fi-list",title:"Menu","data-dropdown":this.state.auxId+"Menu"})),p({updateTask:this.updateTask,tasks:this.props.query.tasks,hasGoogleMaps:this.props.hasGoogleMaps}),React.DOM.div({className:a},this.props.query.tasks.map(function(a,b){return n({key:a.id,index:b,task:a,setTaskFocus:this.props.setTaskFocus,
removeTask:this.removeTask})}.bind(this))))}});e=React.createClass({displayName:"TaskInput",getInitialState:function(){return{filters:[]}},pushQuery:function(a,b){var d=this.props.queries,c={};c.query=a;c.tasks=b;d.push(c);this.props.setQueries(d);this.setState({filters:[]})},setQuery:function(a,b){var d=this.props.queries;d[b]=a;this.props.setQueries(d)},popQuery:function(a){var b=this.props.queries.concat();b.splice(a,1);this.props.setQueries(b)},removeFilter:function(a){var b=[].concat(this.state.filters);
b.splice(a,1);this.setState({filters:b})},createFilter:function(a){a.preventDefault();a=this.state.filters;var b=this.refs.filterType.getDOMNode();a.push({id:b.value,key:"filter-"+Math.random().toString(36).substr(2),name:$(b).find("option:selected").text()});this.setState({filters:a})},createTask:function(a){a.preventDefault()},render:function(){return React.DOM.div({className:"panel contained"},React.DOM.form({onSubmit:this.createFilter},React.DOM.div(null,React.DOM.label(null,"Filtrar por",React.DOM.select({name:"type",
ref:"filterType"},_.map(q,function(a,b){return React.DOM.option({key:b,value:b},a)})))),React.DOM.div({className:"row"},React.DOM.div({className:"large-12 columns text-right"},React.DOM.button({disabled:!0,className:"tiny secondary button",onClick:this.createTask},"+ Ordem"),React.DOM.button({type:"submit",className:"tiny success button"},"+ Filtro")))),this.state.filters.length?f({removeFilter:this.removeFilter,filters:this.state.filters,pushQuery:this.pushQuery}):null,React.DOM.div({className:"panel sequential contained"},
this.props.queries.map(function(a,b){return l({routeThem:this.props.routeThem,setTaskFocus:this.props.setTaskFocus,hasGoogleMaps:this.props.hasGoogleMaps,popQuery:this.popQuery,setQuery:this.setQuery,key:a.id,index:b,query:a})}.bind(this))))}});return React.createClass({displayName:"Tasks",routeThem:function(a){this.props.routeTasks(s(a))},routeThemAll:function(a){a.stopPropagation();var b=[];this.props.queries.forEach(function(a){a.tasks.forEach(function(a){_.any(a,{sys_id:a.sys_id})||b.push(a)})});
this.routeThem(b)},toggleContent:function(a){$(a.currentTarget).next(".panel").toggle()},render:function(){return React.DOM.div({id:"Tasks"},React.DOM.h4({onClick:this.toggleContent},"Ordens livres",React.DOM.a({onClick:this.routeThemAll,className:"right radius ico fi-fast-forward",title:"Rotear todos"})),e({routeThem:this.routeThem,locations:this.props.locations,day:this.props.day,setTaskFocus:this.props.setTaskFocus,hasGoogleMaps:this.props.hasGoogleMaps,setQueries:this.props.setQueries,queries:this.props.queries}))}})});
