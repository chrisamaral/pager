define(["../helpers/utils.js"],function(d){var e=React.createClass({displayName:"PlaceInput",componentDidMount:function(){$(this.refs.pInput.getDOMNode()).geocomplete().bind("geocode:result",function(a,b){if(this.isMounted()&&b){var c=this.refs.pInput.getDOMNode();setTimeout(function(){$(c).val("")},500);this.props.newPlace({address:b.formatted_address,location:{lat:b.geometry.location.lat(),lng:b.geometry.location.lng()}})}}.bind(this))},noAction:function(a){a.preventDefault()},render:function(){return React.DOM.form({onSubmit:this.noAction},
React.DOM.div({className:"row"},React.DOM.div({className:"small-12 columns"},React.DOM.label(null,"Endere\u00e7o do novo local",React.DOM.input({type:"text",ref:"pInput",name:"address",placeholder:"Avenida Rio Branco 1, Rio de Janeiro"})))))}}),f=React.createClass({displayName:"PlaceForm",getInitialState:function(){return{mapURL:null}},componentDidMount:function(){d.loadAPIKeys(function(a){if(this.isMounted()){var b=this.refs.mapContainer.getDOMNode();this.setState({mapURL:"http://maps.googleapis.com/maps/api/staticmap?markers="+
this.props.place.location.lat+","+this.props.place.location.lng+"&zoom=14&size="+$(b).width()+"x300&key="+a.google})}}.bind(this))},handleSubmit:function(a){a.preventDefault();var b=[];$(a.currentTarget).find(":checkbox").each(function(){$(this).is(":checked")&&b.push($(this).val())});this.props.savePlace({name:this.refs.nameInput.getDOMNode().value,tags:b},this.props.place._id)},removeMe:function(a){a.preventDefault();this.props.removePlace(this.props.place._id)},render:function(){var a=this.props.place;
return React.DOM.fieldset(null,React.DOM.legend(null,this.props.place.address),React.DOM.form({onSubmit:this.handleSubmit},React.DOM.div({className:"row"},React.DOM.div({className:"small-7 columns"},React.DOM.div({className:"row"},React.DOM.div({className:"small-12 columns"},React.DOM.label(null,"D\u00ea um nome a este local",React.DOM.input({type:"text",ref:"nameInput",name:"name",required:!0,placeholder:"Sede, Almoxarifado, Posto de Gasolina",defaultValue:this.props.place.name})))),this.props.avaibleTags.map(function(b){return React.DOM.div({className:"row",
key:b.value},React.DOM.div({className:"small-12 columns"},React.DOM.input({id:"tagType"+b.value+a._id,type:"checkbox",value:b.value,defaultChecked:_.isArray(a.tags)&&0<=a.tags.indexOf(b.value)}),React.DOM.label({htmlFor:"tagType"+b.value+a._id},b.name)))}),React.DOM.div({className:"row"},React.DOM.div({className:"small-12 columns text-right"},React.DOM.button({className:"button success small"},"Salvar"),React.DOM.a({onClick:this.removeMe,className:"button alert small"},"Remover")))),React.DOM.div({className:"small-5 columns",
ref:"mapContainer"},this.state.mapURL?React.DOM.img({src:this.state.mapURL}):React.DOM.div(null,"Carregando...")))))}});return React.createClass({displayName:"Places",getInitialState:function(){return{mapsLoaded:!1,geoCompleteLoaded:!1,places:[],avaibleTags:[{name:"Ponto de Sa\u00edda",value:"origin"},{name:"Parada opcional",value:"pitstop"}]}},loadMaps:function(){if("undefined"!==typeof google&&google&&google.maps&&google.maps.places)return this.setState({mapsLoaded:!0});d.loadAPIKeys(function(a){var b=
this,c="PagerCallback_"+Math.random().toString(36).substr(2);b.isMounted()&&(window[c]=function(){b.isMounted()&&b.setState({mapsLoaded:!0});delete window[c]},LazyLoad.js(["//maps.googleapis.com/maps/api/js?libraries=places&callback="+c+"&key="+a.google]))}.bind(this))},loadGeocomplete:function(){if($.fn.geocomplete)return this.setState({geoCompleteLoaded:!0});LazyLoad.js([pager.build.moduleRoot+"/ext/jquery.geocomplete.js"],function(){this.setState({geoCompleteLoaded:!0})}.bind(this))},componentDidMount:function(){this.loadMaps();
this.loadGeocomplete();this.reloadPlaces()},reloadPlaces:function(){return $.get(pager.urls.ajax+"admin/places").done(function(a){this.setState({places:a})}.bind(this))},removePlace:function(a){$.ajax({type:"DELETE",url:pager.urls.ajax+"admin/place/"+a}).done(this.reloadPlaces)},savePlace:function(a,b){$.ajax({type:"POST",url:pager.urls.ajax+"admin/place"+(b?"/"+b:""),contentType:"application/json; charset=utf-8",data:JSON.stringify({place:a})}).done(this.reloadPlaces)},render:function(){return React.DOM.div(null,
this.state.mapsLoaded&&this.state.geoCompleteLoaded?e({newPlace:this.savePlace}):null,this.state.places.map(function(a){return f({avaibleTags:this.state.avaibleTags,key:a._id,place:a,removePlace:this.removePlace,savePlace:this.savePlace})}.bind(this)))}})});
