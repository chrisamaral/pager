/** @jsx React.DOM */define(function(){function n(e){_.forEach(e,function(e){e.close()});for(var t in e)e.hasOwnProperty(t)&&delete e[t]}var e,t;return e=React.createClass({displayName:"Map",getInitialState:function(){return{markers:[],infoW:{}}},massTaskMarker:function(e){return _.forEach(e,function(e){if(e.marker!==undefined||e.location===undefined)return;e.marker=new google.maps.Marker({title:e.address.address,map:pager.console.map,icon:"/icons/default_marker.png",position:new google.maps.LatLng(e.location.lat,e.location.lng)}),google.maps.event.addListener(e.marker,"click",function(){var t=$('[data-task="'+e._id+'"]'),n=$(document.body);t.length&&t.is(":visible")&&n.animate({scrollTop:n.scrollTop()+t.offset().top-n.offset().top-10}),this.props.setTaskFocus(e._id)}.bind(this))},this),e},selectedTaskClick:function(e){function s(){n[e._id].close(),delete n[e._id],this.setState({infoW:n})}var n=this.state.infoW,r,i;if(n[e._id])return s.call(this);r=$('<div class="consoleInfoWindow">'),i=$('[data-task="'+e.task._id+'"]'),i.length&&i.is(":visible")?r.append("<p>"+e.task.address.address+"</p>"):r.append(React.renderComponentToString(t({attrs:e.task.attrs}))),r.append($("<p>").append($('<a title="Ver todos"><i class="fi-arrow-left"></i></a>').click(function(){this.props.setTaskFocus(e._id),s.call(this)}.bind(this)))),n[e._id]=new google.maps.InfoWindow({content:r[0]}),n[e._id].open(pager.console.map,e.marker),this.setState({infoW:n}),google.maps.event.addListener(n[e._id],"closeclick",function(){var t=this.state.infoW;delete t[e._id],this.setState({infoW:t})}.bind(this))},filterTasks:function(e){var t=[],n=this.state.markers;return e.mapState!==pager.constant.console.map.ROUTER_PROJECTION&&e.queries.forEach(function(r){r.tasks.forEach(function(r){function u(){o.marker.setMap(null),delete o.marker}if(!r.location)return;var i={_id:r._id},s=_.findIndex(n,i),o=n[s];i.location=r.location,i.address=r.address,i.task=r,o&&o.marker&&(e.mapState===pager.constant.console.map.AVAILABLE_TASKS&&!o.hasSelectedMarker||e.mapState===pager.constant.console.map.SELECTED_TASK&&o.hasSelectedMarker&&o._id===e.selectedTask?i.marker=o.marker:u()),t.push(i),s>=0&&n.splice(s,1)}.bind(this))}.bind(this)),n.forEach(function(e){e.marker&&e.marker.setMap(null)}),t},updateMapView:function(e){t=t||pager.components.AttrTable;var r=e||this.props,i=this.state.infoW,s,o,u=this,a;console.log("update map view");switch(r.mapState){case pager.constant.console.map.AVAILABLE_TASKS:s=this.filterTasks(r),s=this.massTaskMarker(s);break;case pager.constant.console.map.SELECTED_TASK:s=this.filterTasks(r),a=_.find(s,{_id:r.selectedTask}),a&&(a.hasSelectedMarker=!0,a.marker||(o=new google.maps.LatLng(a.location.lat,a.location.lng),a.marker=new google.maps.Marker({title:a.address.address,map:pager.console.map,icon:"/icons/selected_marker.png",position:o}),pager.console.map.panTo(o),n(i),this.selectedTaskClick(a),google.maps.event.addListener(a.marker,"click",function(){this.selectedTaskClick(a)}.bind(this))));break;case pager.constant.console.map.ROUTER_PROJECTION:s=this.filterTasks(r),n(i),s=r.routerWorker.wayPoints.map(function(e){return e.marker=new google.maps.Marker({map:pager.console.map,icon:"/icons/fixed_marker.png",position:new google.maps.LatLng(e.location.lat,e.location.lng)}),google.maps.event.addListener(e.marker,"click",function(){function n(){i[e.id].close(),delete i[e.id],u.setState({infoW:i})}if(i[e.id])return n();i[e.id]=new google.maps.InfoWindow({content:$('<div class="consoleInfoWindow">').append(React.renderComponentToString(t({attrs:e.attrs})))[0]}),i[e.id].open(pager.console.map,e.marker),u.setState({infoW:i}),google.maps.event.addListener(i[e.id],"closeclick",function(){var t=u.state.infoW;delete t[e.id],u.setState({infoW:t})})}),e})}this.setState({markers:s,infoW:i})},componentDidMount:function(){function i(){$(window).off("scroll resize",r)}var e={zoom:8,center:new google.maps.LatLng(-22.848658,-43.300933),zoomControl:!1,panControl:!1,scaleControl:!1,streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM}},t=this,n=function(e){if(!t.isMounted())return i();var n,r=$("body"),s=$("#Console"),o=r.scrollTop(),u=s.position().top;n={top:u,width:s.width(),height:t.props.height},$(t.getDOMNode()).css(n)},r=_.throttle(n,100);$(window).on("scroll resize",r),n(),pager.console=pager.console||{},pager.console.map=new google.maps.Map($("<div>").appendTo(this.getDOMNode())[0],e),setTimeout(function(){this.updateMapView()}.bind(this),1e3)},componentWillReceiveProps:function(e){this.updateMapView(e)},render:function(){return React.DOM.div({id:"ConsoleMainMap"})}}),e});