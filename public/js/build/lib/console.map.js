define(function(){function k(a,f){return function(){function b(){d[a._id].close();delete d[a._id]}if(d[a._id])return b();d[a._id]=new google.maps.InfoWindow({content:$('<div class="consoleInfoWindow">').append(React.renderComponentToString(g({attrs:a.task.attrs}))).append($("<p>").append($('<a title="Ver todos"><i class="fi-arrow-left"></i></a>').click(function(){f.props.setTaskFocus(a._id);b()})))[0]});d[a._id].open(pager.console.map,a.marker);google.maps.event.addListener(d[a._id],"closeclick",
function(){delete d[a._id]})}}var d={},g;return React.createClass({displayName:"Map",getInitialState:function(){return{markedTasks:[]}},massTaskMarker:function(a){_.forEach(a,function(a){void 0===a.marker&&void 0!==a.location&&(a.marker=new google.maps.Marker({title:a.address.address,map:pager.console.map,icon:"/icons/default_marker.png",position:new google.maps.LatLng(a.location.lat,a.location.lng)}),google.maps.event.addListener(a.marker,"click",function(){var b=$('[data-task="'+a._id+'"]'),c=document.getElementById("LeftPanel");
b.length&&(b.closest(".QueryElem").show().closest(".TaskInput").show(),$(c).animate({scrollTop:c.scrollTop+b.offset().top-$(c).offset().top-10}));this.props.setTaskFocus(a._id)}.bind(this)))},this);this.setState({markedTasks:a})},filterTasks:function(a){var d=[],b=this.state.markedTasks;a.queries.forEach(function(a){a.tasks.forEach(function(a){if(a.location){var c={_id:a._id},h=_.findIndex(b,c),e=b[h];c.location=a.location;c.address=a.address;c.task=a;e&&e.marker&&e.isSelected?e.marker.setMap(null):
e&&e.marker&&(c.marker=e.marker);d.push(c);0<=h&&b.splice(h,1)}}.bind(this))}.bind(this));b.forEach(function(a){a.marker&&a.marker.setMap(null)});return d},updateMapView:function(a){var f=a||this.props,b,c;a=this.filterTasks(f);console.log("update map view");"tasks"===f.mapState?this.massTaskMarker(a):"task"===f.mapState&&(a.forEach(function(a){a.marker&&(a.marker.setMap(null),delete a.marker);a._id===f.selectedTask&&(a.isSelected=!0,b=new google.maps.LatLng(a.location.lat,a.location.lng),a.marker=
new google.maps.Marker({title:a.address.address,map:pager.console.map,icon:"/icons/selected_marker.png",position:b}),pager.console.map.panTo(b),_.forEach(d,function(a,b){a.close();delete d[b]}),g=g||pager.components.AttrTable,c=k(a,this),google.maps.event.addListener(a.marker,"click",c))}.bind(this)),this.setState({markedTasks:a}))},componentDidMount:function(){var a={zoom:8,center:new google.maps.LatLng(-22.848658,-43.300933),zoomControl:!1,panControl:!1,scaleControl:!1,streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM}};
pager.console=pager.console||{};pager.console.map=new google.maps.Map(this.getDOMNode(),a);setTimeout(function(){this.updateMapView()}.bind(this),1E3)},componentWillReceiveProps:function(a){this.updateMapView(a)},render:function(){return React.DOM.div({id:"ConsoleMainMap"})}})});
